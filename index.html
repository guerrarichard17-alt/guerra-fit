<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Guerra Fit ‚Äì Treinos, Corrida e Alimenta√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      padding: 12px 16px 10px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header small {
      color: #9ca3af;
      font-size: 12px;
    }
    main {
      padding: 10px;
      max-width: 960px;
      margin: 0 auto;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px;
      margin-bottom: 10px;
    }
    label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }
    input[type="file"],
    select,
    input[type="date"],
    input[type="number"],
    input[type="text"],
    textarea {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #4b5563;
      padding: 6px 8px;
      font-size: 13px;
      color: #e5e7eb;
      box-sizing: border-box;
      width: 100%;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col-6 {
      flex: 1 1 48%;
      min-width: 150px;
    }
    @media (max-width: 640px) {
      .col-6 {
        flex: 1 1 100%;
      }
    }
    .top-tabs {
      display: flex;
      gap: 6px;
    }
    .top-tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }
    .top-tab-btn.active {
      background: #16a34a;
      border-color: #16a34a;
    }
    .tabs-treino,
    .tabs-alim {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .tab-btn-treino,
    .tab-btn-alim {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn-treino.active,
    .tab-btn-alim.active {
      background: #2563eb;
      border-color: #2563eb;
    }
    .status {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .help-text {
      font-size: 11px;
      color: #9ca3af;
    }
    .exercise-card {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px;
      margin-bottom: 8px;
    }
    .exercise-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }
    .exercise-title {
      font-size: 13px;
      font-weight: 600;
    }
    .exercise-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    .pill {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 10px;
    }
    .exercise-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    @media (max-width: 640px) {
      .exercise-fields {
        grid-template-columns: 1fr;
      }
    }
    .field-block {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .field-block label {
      font-size: 11px;
    }
    .bottom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    button {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
    }
    button.primary {
      background: #2563eb;
      border-color: #2563eb;
    }
    .hidden {
      display: none;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    @media (max-width: 640px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
    .summary-box {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 12px;
    }
    .summary-title {
      font-size: 12px;
      font-weight: 600;
    }
    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 10px;
      display: inline-block;
      margin-right: 4px;
    }
    .shopping-category {
      margin-bottom: 8px;
    }
    .shopping-category-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .shopping-item {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }
    .meal-block {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .meal-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
<header>
  <h1>Guerra Fit</h1>
  <small>Treinos, corrida e alimenta√ß√£o ‚Äì semana iniciando na ter√ßa.</small>
</header>
<main>
  <!-- Navega√ß√£o principal: Treinos x Alimenta√ß√£o -->
  <div class="card">
    <div class="top-tabs">
      <button class="top-tab-btn active" data-main="treino">Treinos</button>
      <button class="top-tab-btn" data-main="alimentacao">Alimenta√ß√£o</button>
    </div>
  </div>

  <!-- VISTA TREINO -->
  <div id="view-treino">
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label for="fileInput">Arquivo de treinos (.csv)</label>
          <input type="file" id="fileInput" accept=".csv">
        </div>
        <div class="col-6">
          <label for="diaSelect">Dia do treino</label>
          <select id="diaSelect"></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="col-6">
          <label for="dataInput">Data do treino</label>
          <input type="date" id="dataInput">
        </div>
        <div class="col-6">
          <label>&nbsp;</label>
          <div class="help-text">
            Peso corporal, cargas, corrida (tempo, km, esteira/rua) e RPE s√£o salvos automaticamente no navegador.
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="col-6">
          <button id="btnExport" class="primary">Exportar dados (.json)</button>
        </div>
        <div class="col-6">
          <button id="btnReset">Limpar dados deste dia</button>
        </div>
      </div>
      <div class="status" id="statusText">Carregue o arquivo de treinos para come√ßar (treinos_guerra_corrida.csv).</div>
    </div>

    <div class="card">
      <div class="tabs-treino">
        <button class="tab-btn-treino active" data-tab="dia">Treino do dia</button>
        <button class="tab-btn-treino" data-tab="cardio">Cardio (corrida) ‚Äì dia / semana</button>
      </div>

      <div id="tab-dia">
        <div id="diaInfo" class="help-text" style="margin-bottom:6px;"></div>
        <div id="diaContainer"></div>
      </div>

      <div id="tab-cardio" class="hidden">
        <div class="summary-grid">
          <div class="summary-box">
            <div class="summary-title">Cardio do dia</div>
            <div id="cardioDiaResumo">
              Nenhum registro de corrida/caminhada ainda para esta data.
            </div>
          </div>
          <div class="summary-box">
            <div class="summary-title">Cardio √∫ltimos 7 dias</div>
            <div id="cardioSemanaResumo">
              Nenhum registro nos √∫ltimos 7 dias.
            </div>
          </div>
        </div>
        <div class="help-text" style="margin-top:6px;">
          S√£o considerados cardio os exerc√≠cios com grupo "Corrida", "Aquecimento", "Recupera√ß√£o"
          ou tipo contendo "Cardio".
        </div>
      </div>
    </div>
  </div>

  <!-- VISTA ALIMENTA√á√ÉO -->
  <div id="view-alimentacao" class="hidden">
    <div class="card">
      <div class="tabs-alim">
        <button class="tab-btn-alim active" data-tab="alim-dia">Card√°pio do dia</button>
        <button class="tab-btn-alim" data-tab="alim-semana">Card√°pio da semana</button>
        <button class="tab-btn-alim" data-tab="alim-compras">Lista de compras</button>
      </div>

      <!-- Card√°pio do dia -->
      <div id="tab-alim-dia">
        <div id="cardapioDiaInfo" class="help-text" style="margin-bottom:6px;"></div>
        <div id="cardapioDiaContainer"></div>
      </div>

      <!-- Card√°pio da semana -->
      <div id="tab-alim-semana" class="hidden">
        <div id="cardapioSemanaContainer" class="help-text"></div>
      </div>

      <!-- Lista de compras -->
      <div id="tab-alim-compras" class="hidden">
        <div class="help-text" style="margin-bottom:6px;">
          Lista base para 1 semana de dieta (~2.200‚Äì2.400 kcal/dia, alto em prote√≠na).
          Marque o que j√° comprou.
        </div>
        <div id="shoppingContainer"></div>
      </div>
    </div>
  </div>
</main>

<script>
const STORAGE_KEY = "treino_diario_guerra_v1_mobile";
const SHOPPING_KEY = "guerra_fit_shopping_v1";

let baseExercises = [];
let dailyLog = {};

const shoppingItems = [
  { id: "frango", label: "Peito de frango (2‚Äì3kg)", category: "Prote√≠nas" },
  { id: "ovos", label: "Ovos (36 unidades)", category: "Prote√≠nas" },
  { id: "carne_mag", label: "Carne vermelha magra (1‚Äì2kg)", category: "Prote√≠nas" },
  { id: "peixe", label: "Peixe (1kg)", category: "Prote√≠nas" },
  { id: "iogurte", label: "Iogurte natural/greco sem a√ß√∫car (6√ó500g)", category: "Prote√≠nas" },
  { id: "cottage", label: "Cottage ou ricota (500g)", category: "Prote√≠nas" },

  { id: "arroz_int", label: "Arroz integral (2kg)", category: "Carboidratos" },
  { id: "batata_doce", label: "Batata doce (2,5kg)", category: "Carboidratos" },
  { id: "aveia", label: "Aveia em flocos (1kg)", category: "Carboidratos" },
  { id: "pao_int", label: "P√£o integral 100% (2 pacotes)", category: "Carboidratos" },
  { id: "banana", label: "Banana (14 unidades)", category: "Carboidratos" },
  { id: "maca", label: "Ma√ß√£ (7 unidades)", category: "Carboidratos" },

  { id: "verd_verde", label: "Folhas verdes (3 pacotes)", category: "Verduras/Legumes" },
  { id: "brocolis", label: "Br√≥colis (2 cabe√ßas)", category: "Verduras/Legumes" },
  { id: "abobrinha", label: "Abobrinha (4 unidades)", category: "Verduras/Legumes" },
  { id: "cenoura", label: "Cenoura (1kg)", category: "Verduras/Legumes" },
  { id: "tomate", label: "Tomate (1,5kg)", category: "Verduras/Legumes" },

  { id: "azeite", label: "Azeite de oliva extra virgem (500ml)", category: "Gorduras boas" },
  { id: "castanhas", label: "Castanhas/nozes/am√™ndoas (600g)", category: "Gorduras boas" },
  { id: "abacate", label: "Abacate (4 unidades)", category: "Gorduras boas" },
  { id: "pasta_amendoim", label: "Pasta de amendoim (450g)", category: "Gorduras boas" },

  { id: "agua", label: "√Ågua (gal√£o/garrafas para a semana)", category: "Suporte" },
  { id: "cafe", label: "Caf√© / ch√° sem a√ß√∫car", category: "Suporte" }
];

function setStatus(msg) {
  const el = document.getElementById("statusText");
  if (el) el.textContent = msg;
}

function todayISO() {
  const d = new Date();
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off * 60000);
  return local.toISOString().slice(0, 10);
}

function loadDailyLog() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      dailyLog = {};
      return;
    }
    dailyLog = JSON.parse(raw);
  } catch (e) {
    console.error("Erro ao carregar dailyLog", e);
    dailyLog = {};
  }
}

function saveDailyLog() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(dailyLog));
}

function getDiaSelecionado() {
  const sel = document.getElementById("diaSelect");
  return sel && sel.value ? sel.value : "";
}

function getDataSelecionada() {
  const inp = document.getElementById("dataInput");
  return inp && inp.value ? inp.value : todayISO();
}

function keyFor(exId, dateStr) {
  return exId + "::" + dateStr;
}

function getLog(exId, dateStr) {
  const key = keyFor(exId, dateStr);
  if (!dailyLog[key]) {
    dailyLog[key] = {
      peso: "",
      rpePercebido: "",
      carga1: "",
      carga2: "",
      carga3: "",
      carga4: "",
      tempoCardioMin: "",
      distCardioKm: "",
      cardioTipo: "",
      obs: "",
      concluido: false
    };
  }
  return dailyLog[key];
}

function updateLogField(exId, field, value) {
  const dateStr = getDataSelecionada();
  const log = getLog(exId, dateStr);
  log[field] = value;
  const key = keyFor(exId, dateStr);
  dailyLog[key] = log;
  saveDailyLog();
  updateCardioSummary();
}

function updateLogCheckbox(exId, field, checked) {
  updateLogField(exId, field, !!checked);
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (lines.length < 2) return [];
  let delimiter = ";";
  const headerLine = lines[0];
  if (headerLine.includes(",") && !headerLine.includes(";")) delimiter = ",";
  const headers = headerLine.split(delimiter).map(h => h.trim());
  function getVal(cells, name) {
    const idx = headers.indexOf(name);
    return idx === -1 ? "" : (cells[idx] || "").trim();
  }
  const out = [];
  for (let i = 1; i < lines.length; i++) {
    const cells = lines[i].split(delimiter);
    const row = {
      dia: getVal(cells, "Dia"),
      grupo: getVal(cells, "Grupo"),
      exercicio: getVal(cells, "Exerc√≠cio"),
      tipo: getVal(cells, "Tipo"),
      series: getVal(cells, "S√©ries"),
      repsTempo: getVal(cells, "Reps/Tempo"),
      rpeZona: getVal(cells, "RPE/Zona"),
      aquecimento: getVal(cells, "Aquecimento?"),
      midia: getVal(cells, "Link v√≠deo")
    };
    if (Object.values(row).every(v => !v)) continue;
    out.push(row);
  }
  return out;
}

function rebuildDiaOptions() {
  const sel = document.getElementById("diaSelect");
  if (!sel) return;
  const dias = Array.from(new Set(baseExercises.map(e => (e.dia || "").trim()))).filter(Boolean);

  const ordemDesejada = ["Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo", "Segunda"];
  dias.sort((a, b) => {
    const ia = ordemDesejada.indexOf(a);
    const ib = ordemDesejada.indexOf(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b);
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Selecione o dia";
  sel.appendChild(opt0);
  dias.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    sel.appendChild(opt);
  });

  const hoje = new Date();
  const wd = hoje.getDay();
  const mapa = {
    0: "Domingo",
    1: "Segunda",
    2: "Ter√ßa",
    3: "Quarta",
    4: "Quinta",
    5: "Sexta",
    6: "S√°bado"
  };
  const nomeHoje = mapa[wd] || "";
  const found = dias.find(d => d === nomeHoje);
  if (found) sel.value = found;
}

function renderDia() {
  const container = document.getElementById("diaContainer");
  const info = document.getElementById("diaInfo");
  if (!container || !info) return;
  container.innerHTML = "";

  if (!baseExercises.length) {
    info.textContent = "Carregue um arquivo de treinos (.csv).";
    return;
  }

  const diaSel = getDiaSelecionado();
  const dataSel = getDataSelecionada();
  if (!diaSel) {
    info.textContent = "Selecione o dia do treino.";
    return;
  }
  info.textContent = "Treino de " + diaSel + " em " + dataSel + ".";

  const doDia = baseExercises.filter(e => (e.dia || "").trim() === diaSel);
  if (!doDia.length) {
    container.innerHTML = "<div class='help-text'>Nenhum exerc√≠cio encontrado para este dia.</div>";
    return;
  }

  doDia.forEach((ex, idx) => {
    const exId = "ex_" + idx + "_" + diaSel;
    const log = getLog(exId, dataSel);

    const isCardio = (ex.grupo || "").toLowerCase().includes("corrida");

    const card = document.createElement("div");
    card.className = "exercise-card";

    /* --- T√≠tulo --- */
    const header = document.createElement("div");
    header.className = "exercise-header";

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.className = "exercise-title";
    title.textContent = ex.exercicio || "";
    const sub = document.createElement("div");
    sub.className = "exercise-sub";
    sub.textContent = (ex.grupo || "") + (ex.tipo ? " ‚Ä¢ " + ex.tipo : "");
    left.appendChild(title);
    left.appendChild(sub);
    header.appendChild(left);

    /* --- Badge: Agora curto e limpo --- */
    const badge = document.createElement("div");
    badge.className = "pill";
    badge.textContent = isCardio ? "Corrida ‚Ä¢ Zona alvo" : ex.repsTempo;
    header.appendChild(badge);
    card.appendChild(header);

    /* --- NOVO BLOCO DE META (somente corrida) --- */
    if (isCardio) {
      const meta = document.createElement("div");
      meta.style.padding = "6px 0 10px 0";
      meta.style.fontSize = "12px";

      meta.innerHTML = `
        <div style="margin-bottom:6px; font-weight:600;">üéØ Meta da corrida</div>
        <div><b>Tempo:</b> ${ex.repsTempo || "‚Äî"}</div>
        <div><b>Intensidade:</b> ${ex.rpeZona || "‚Äî"}</div>
      `;

      card.appendChild(meta);
    }

    /* --- Campos --- */
    const fields = document.createElement("div");
    fields.className = "exercise-fields";

    // Peso corporal
    const fbPeso = document.createElement("div");
    fbPeso.className = "field-block";
    fbPeso.innerHTML = `
      <label>Peso corporal (kg)</label>
      <input type="number" step="0.1" value="${log.peso || ""}"/>
    `;
    fbPeso.querySelector("input").onchange = e => updateLogField(exId, "peso", e.target.value);
    fields.appendChild(fbPeso);

    // RPE percebido
    const fbRPE = document.createElement("div");
    fbRPE.className = "field-block";
    fbRPE.innerHTML = `
      <label>RPE percebido (1‚Äì10)</label>
      <input type="number" step="0.5" min="1" max="10" value="${log.rpePercebido || ""}"/>
    `;
    fbRPE.querySelector("input").onchange = e => updateLogField(exId, "rpePercebido", e.target.value);
    fields.appendChild(fbRPE);

    /* --- Campos de corrida: vers√£o limpa --- */
    if (isCardio) {
      // Tipo
      const fbTipo = document.createElement("div");
      fbTipo.className = "field-block";
      fbTipo.innerHTML = `
        <label>Tipo de corrida</label>
        <select>
          <option value="">Selecione</option>
          <option value="Esteira">Esteira</option>
          <option value="Rua">Rua/Outdoor</option>
        </select>
      `;
      fbTipo.querySelector("select").value = log.cardioTipo || "";
      fbTipo.querySelector("select").onchange = e => updateLogField(exId, "cardioTipo", e.target.value);
      fields.appendChild(fbTipo);

      // Tempo realizado
      const fbTempo = document.createElement("div");
      fbTempo.className = "field-block";
      fbTempo.innerHTML = `
        <label>Tempo realizado (min)</label>
        <input type="number" step="1" value="${log.tempoCardioMin || ""}"/>
      `;
      fbTempo.querySelector("input").onchange = e => updateLogField(exId, "tempoCardioMin", e.target.value);
      fields.appendChild(fbTempo);

      // Dist√¢ncia realizada
      const fbDist = document.createElement("div");
      fbDist.className = "field-block";
      fbDist.innerHTML = `
        <label>Dist√¢ncia realizada (km)</label>
        <input type="number" step="0.1" value="${log.distCardioKm || ""}"/>
      `;
      fbDist.querySelector("input").onchange = e => updateLogField(exId, "distCardioKm", e.target.value);
      fields.appendChild(fbDist);
    }

    /* Observa√ß√µes */
    const fbObs = document.createElement("div");
    fbObs.className = "field-block";
    fbObs.innerHTML = `
      <label>Observa√ß√µes</label>
      <textarea>${log.obs || ""}</textarea>
    `;
    fbObs.querySelector("textarea").onchange = e => updateLogField(exId, "obs", e.target.value);
    fields.appendChild(fbObs);

    card.appendChild(fields);

    /* Conclu√≠do e v√≠deo */
    const bottom = document.createElement("div");
    bottom.className = "bottom-row";

    const chkWrap = document.createElement("label");
    chkWrap.style.fontSize = "11px";
    chkWrap.innerHTML = `
      <input type="checkbox" ${log.concluido ? "checked" : ""}> Exerc√≠cio conclu√≠do
    `;
    chkWrap.querySelector("input").onchange = e => updateLogCheckbox(exId, "concluido", e.target.checked);
    bottom.appendChild(chkWrap);

    if (ex.midia) {
      const btn = document.createElement("button");
      btn.textContent = "V√≠deo / imagem";
      btn.onclick = () => window.open(ex.midia, "_blank");
      bottom.appendChild(btn);
    }

    card.appendChild(bottom);
    container.appendChild(card);
  });

  updateCardioSummary();
}

function updateCardioSummary() {
  const diaSel = getDiaSelecionado();
  const dataSel = getDataSelecionada();
  const diaDiv = document.getElementById("cardioDiaResumo");
  const semDiv = document.getElementById("cardioSemanaResumo");
  if (!diaDiv || !semDiv) return;

  if (!baseExercises.length || !diaSel) {
    diaDiv.textContent = "Selecione um dia e registre pelo menos uma corrida/caminhada.";
    semDiv.textContent = "Nenhum registro para calcular.";
    return;
  }

  let totalMinDia = 0;
  let totalKmDia = 0;
  Object.keys(dailyLog).forEach(key => {
    const parts = key.split("::");
    const exId = parts[0];
    const data = parts[1];
    if (data !== dataSel) return;
    const log = dailyLog[key];
    const match = exId.match(/^ex_(\d+)_/);
    if (!match) return;
    const idx = parseInt(match[1], 10);
    const diaEx = getDiaSelecionado();
    const doDia = baseExercises.filter(e => (e.dia || "").trim() === diaEx);
    const ex = doDia[idx];
    if (!ex) return;
    const isCardio = (ex.grupo || "").toLowerCase().includes("corrida") ||
                     (ex.grupo || "").toLowerCase().includes("recupera√ß√£o") ||
                     (ex.grupo || "").toLowerCase().includes("aquecimento") ||
                     (ex.tipo || "").toLowerCase().includes("cardio");
    if (!isCardio) return;
    const min = parseFloat(log.tempoCardioMin || "0") || 0;
    const km = parseFloat(log.distCardioKm || "0") || 0;
    totalMinDia += min;
    totalKmDia += km;
  });
  if (totalMinDia > 0 || totalKmDia > 0) {
    diaDiv.innerHTML = "<span class='badge'>Hoje</span> " +
                       totalMinDia.toFixed(0) + " min ¬∑ " +
                       totalKmDia.toFixed(2) + " km";
  } else {
    diaDiv.textContent = "Nenhum registro de corrida/caminhada para esta data.";
  }

  let totalMinSem = 0;
  let totalKmSem = 0;
  const baseDate = new Date(dataSel);
  Object.keys(dailyLog).forEach(key => {
    const parts = key.split("::");
    const data = parts[1];
    const d = new Date(data);
    const diff = (baseDate - d) / (1000*60*60*24);
    if (diff < 0 || diff > 7) return;
    const log = dailyLog[key];
    const exId = parts[0];
    const match = exId.match(/^ex_(\d+)_([^:]+)$/);
    if (!match) return;
    const idx = parseInt(match[1], 10);
    const diaEx = match[2];
    const doDia = baseExercises.filter(e => (e.dia || "").trim() === diaEx);
    const ex = doDia[idx];
    if (!ex) return;
    const isCardio = (ex.grupo || "").toLowerCase().includes("corrida") ||
                     (ex.grupo || "").toLowerCase().includes("recupera√ß√£o") ||
                     (ex.grupo || "").toLowerCase().includes("aquececimento") ||
                     (ex.tipo || "").toLowerCase().includes("cardio");
    if (!isCardio) return;
    const min = parseFloat(log.tempoCardioMin || "0") || 0;
    const km = parseFloat(log.distCardioKm || "0") || 0;
    totalMinSem += min;
    totalKmSem += km;
  });
  if (totalMinSem > 0 || totalKmSem > 0) {
    semDiv.innerHTML = "<span class='badge'>√öltimos 7 dias</span> " +
                       totalMinSem.toFixed(0) + " min ¬∑ " +
                       totalKmSem.toFixed(2) + " km";
  } else {
    semDiv.textContent = "Nenhum registro de cardio nos √∫ltimos 7 dias.";
  }
}

function exportJson() {
  const dataStr = JSON.stringify(dailyLog, null, 2);
  const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "guerra_fit_logs.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus("Exportado guerra_fit_logs.json. Envie para o GitHub para versionar sua evolu√ß√£o.");
}

function resetDia() {
  const dataSel = getDataSelecionada();
  const diaSel = getDiaSelecionado();
  if (!diaSel) return;
  const novoLog = {};
  Object.keys(dailyLog).forEach(key => {
    const parts = key.split("::");
    const data = parts[1];
    if (data === dataSel) {
      return;
    }
    novoLog[key] = dailyLog[key];
  });
  dailyLog = novoLog;
  saveDailyLog();
  renderDia();
  setStatus("Dados do dia " + dataSel + " limpos.");
}

function loadShopping() {
  let state = {};
  try {
    const raw = localStorage.getItem(SHOPPING_KEY);
    if (raw) state = JSON.parse(raw);
  } catch (e) {
    state = {};
  }
  const container = document.getElementById("shoppingContainer");
  if (!container) return;
  container.innerHTML = "";

  const byCat = {};
  shoppingItems.forEach(item => {
    if (!byCat[item.category]) byCat[item.category] = [];
    byCat[item.category].push(item);
  });

  Object.keys(byCat).forEach(cat => {
    const catDiv = document.createElement("div");
    catDiv.className = "shopping-category";
    const title = document.createElement("div");
    title.className = "shopping-category-title";
    title.textContent = cat;
    catDiv.appendChild(title);

    byCat[cat].forEach(item => {
      const row = document.createElement("div");
      row.className = "shopping-item";
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = !!state[item.id];
      chk.onchange = (e) => {
        state[item.id] = e.target.checked;
        localStorage.setItem(SHOPPING_KEY, JSON.stringify(state));
      };
      const span = document.createElement("span");
      span.textContent = item.label;
      row.appendChild(chk);
      row.appendChild(span);
      catDiv.appendChild(row);
    });

    container.appendChild(catDiv);
  });
}

function renderCardapioDia() {
  const info = document.getElementById("cardapioDiaInfo");
  const cont = document.getElementById("cardapioDiaContainer");
  if (!info || !cont) return;
  const diaSel = getDiaSelecionado() || "dia padr√£o";
  const dataSel = getDataSelecionada();

  info.textContent = "Sugest√£o b√°sica para " + diaSel + " (" + dataSel + "). Depois ajustamos o card√°pio fino.";

  let tipoDia = "musculacao";
  if (diaSel === "S√°bado" || diaSel === "Domingo") tipoDia = "corrida";
  if (diaSel === "Quinta") tipoDia = "leve";

  const blocos = [];

  if (tipoDia === "musculacao") {
    blocos.push({
      titulo: "Caf√© da manh√£",
      texto: "Ovos + aveia + fruta (banana/ma√ß√£) + caf√© sem a√ß√∫car."
    });
    blocos.push({
      titulo: "Almo√ßo",
      texto: "Frango ou carne magra + arroz integral ou batata doce + salada de folhas + legumes."
    });
    blocos.push({
      titulo: "Lanche pr√©-treino",
      texto: "P√£o integral + pasta de amendoim ou banana + caf√©."
    });
    blocos.push({
      titulo: "Jantar",
      texto: "Peixe ou frango + legumes + salada. Carbo moderado (pouco arroz/batata)."
    });
    blocos.push({
      titulo: "Ceia (opcional)",
      texto: "Iogurte + castanhas, focando prote√≠na e gordura boa."
    });
  } else if (tipoDia === "corrida") {
    blocos.push({
      titulo: "Pr√©-corrida",
      texto: "Carbo leve: banana + mel ou p√£o integral + geleia. 30‚Äì60min antes."
    });
    blocos.push({
      titulo: "P√≥s-corrida",
      texto: "Iogurte + fruta + um pouco de aveia, hidrata√ß√£o com √°gua."
    });
    blocos.push({
      titulo: "Almo√ßo/Jantar",
      texto: "Prote√≠na alta (frango, peixe) + carbo limpo (arroz integral/batata) + bastante legumes."
    });
  } else {
    blocos.push({
      titulo: "Dia leve",
      texto: "Manter padr√£o com prote√≠na alta, carbo moderado e muitas fibras (saladas/legumes)."
    });
  }

  cont.innerHTML = "";
  blocos.forEach(b => {
    const div = document.createElement("div");
    div.className = "meal-block";
    const t = document.createElement("div");
    t.className = "meal-title";
    t.textContent = b.titulo;
    const p = document.createElement("div");
    p.textContent = b.texto;
    div.appendChild(t);
    div.appendChild(p);
    cont.appendChild(div);
  });
}

function renderCardapioSemana() {
  const cont = document.getElementById("cardapioSemanaContainer");
  if (!cont) return;
  cont.innerHTML = `
    <p>
      Estrutura semanal alvo (2.200‚Äì2.400 kcal/dia, ~160‚Äì180g de prote√≠na):
    </p>
    <ul>
      <li>Prote√≠na em TODAS as refei√ß√µes principais (frango, carne magra, peixe, ovos, iogurte).</li>
      <li>Carboidratos mais fortes perto de treino/corrida (arroz, batata doce, p√£o integral, aveia).</li>
      <li>Verduras e legumes em pelo menos 2 refei√ß√µes ao dia.</li>
      <li>Gorduras boas moderadas (azeite, castanhas, abacate, pasta de amendoim).</li>
      <li>√Ågua ao longo do dia, aten√ß√£o especial em dias de corrida.</li>
    </ul>
    <p>
      Depois ajustamos aqui refei√ß√£o por refei√ß√£o (Seg‚ÄìDom) com quantidade aproximada em gramas,
      de acordo com o plano final de macros.
    </p>
  `;
}

function initMainTabs() {
  const buttons = document.querySelectorAll(".top-tab-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const main = btn.dataset.main;
      const vTreino = document.getElementById("view-treino");
      const vAlim = document.getElementById("view-alimentacao");
      if (!vTreino || !vAlim) return;
      vTreino.classList.add("hidden");
      vAlim.classList.add("hidden");
      if (main === "treino") vTreino.classList.remove("hidden");
      if (main === "alimentacao") vAlim.classList.remove("hidden");
    });
  });
}

function initTreinoTabs() {
  const buttons = document.querySelectorAll(".tab-btn-treino");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.getElementById("tab-dia").classList.add("hidden");
      document.getElementById("tab-cardio").classList.add("hidden");
      if (tab === "dia") document.getElementById("tab-dia").classList.remove("hidden");
      if (tab === "cardio") document.getElementById("tab-cardio").classList.remove("hidden");
    });
  });
}

function initAlimentacaoTabs() {
  const buttons = document.querySelectorAll(".tab-btn-alim");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.getElementById("tab-alim-dia").classList.add("hidden");
      document.getElementById("tab-alim-semana").classList.add("hidden");
      document.getElementById("tab-alim-compras").classList.add("hidden");
      if (tab === "alim-dia") document.getElementById("tab-alim-dia").classList.remove("hidden");
      if (tab === "alim-semana") document.getElementById("tab-alim-semana").classList.remove("hidden");
      if (tab === "alim-compras") document.getElementById("tab-alim-compras").classList.remove("hidden");
    });
  });
}

document.addEventListener("DOMContentLoaded", () => {
  loadDailyLog();
  initMainTabs();
  initTreinoTabs();
  initAlimentacaoTabs();
  loadShopping();
  renderCardapioSemana();
  renderCardapioDia();

  const dataInput = document.getElementById("dataInput");
  if (dataInput && !dataInput.value) {
    dataInput.value = todayISO();
  }

  const fileInput = document.getElementById("fileInput");
  if (fileInput) {
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const text = ev.target.result;
          baseExercises = parseCSV(text);
          setStatus("Arquivo carregado com " + baseExercises.length + " linhas de treino.");
          rebuildDiaOptions();
          renderDia();
          renderCardapioDia();
        } catch (err) {
          console.error(err);
          setStatus("Erro ao ler arquivo de treinos.");
        }
      };
      reader.readAsText(file, "utf-8");
    });
  }

  const diaSelect = document.getElementById("diaSelect");
  if (diaSelect) {
    diaSelect.addEventListener("change", () => { renderDia(); renderCardapioDia(); });
  }
  if (dataInput) {
    dataInput.addEventListener("change", () => { renderDia(); renderCardapioDia(); });
  }

  const btnExport = document.getElementById("btnExport");
  if (btnExport) {
    btnExport.addEventListener("click", exportJson);
  }
  const btnReset = document.getElementById("btnReset");
  if (btnReset) {
    btnReset.addEventListener("click", resetDia);
  }
});
</script>
</body>
</html>
