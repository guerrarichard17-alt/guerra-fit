<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Guerra Fit ‚Äì Treinos, Corrida e Alimenta√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  color-scheme: light dark;
}
body {
  margin: 0;
  background: #020617;
  color: #e5e7eb;
}
header {
  padding: 12px 16px 10px;
  background: #020617;
  border-bottom: 1px solid #1f2937;
}
header h1 {
  margin: 0;
  font-size: 20px;
}
header small {
  color: #9ca3af;
  font-size: 12px;
}

main {
  padding: 10px;
  max-width: 960px;
  margin: 0 auto;
}

/* ---------- COMPONENTES GERAIS ---------- */
.card {
  background: #020617;
  border-radius: 12px;
  border: 1px solid #1f2937;
  padding: 12px;
  margin-bottom: 12px;
}
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.col-6 {
  flex: 1 1 48%;
  min-width: 150px;
}
@media (max-width: 640px) {
  .col-6 { flex: 1 1 100%; }
}

label {
  font-size: 12px;
  margin-bottom: 2px;
  display: block;
}
input, select, textarea {
  width: 100%;
  background: #020617;
  border-radius: 8px;
  border: 1px solid #4b5563;
  padding: 6px 8px;
  color: #e5e7eb;
  font-size: 13px;
}
textarea {
  min-height: 60px;
  resize: vertical;
}
button {
  padding: 7px 12px;
  border-radius: 999px;
  border: 1px solid #4b5563;
  background: #020617;
  color: #e5e7eb;
  cursor: pointer;
  font-size: 12px;
}
button.primary {
  background: #2563eb;
  border-color: #2563eb;
}

.top-tabs {
  display: flex;
  gap: 6px;
}
.top-tab-btn {
  flex: 1;
  padding: 10px 10px;
  border-radius: 999px;
  background: #020617;
  border: 1px solid #4b5563;
  color: #e5e7eb;
  font-size: 13px;
}
.top-tab-btn.active {
  background: #16a34a;
  border-color: #16a34a;
}

/* Tabs internas */
.tab-btn-treino,
.tab-btn-alim {
  flex: 1;
  padding: 8px 10px;
  background: #020617;
  border-radius: 999px;
  border: 1px solid #4b5563;
  font-size: 13px;
}
.tab-btn-treino.active {
  background: #2563eb;
}
.tab-btn-alim.active {
  background: #2563eb;
}

.hidden { display: none; }

/* ---------- EXERC√çCIOS ---------- */
.exercise-card {
  border-radius: 12px;
  border: 1px solid #1f2937;
  padding: 12px;
  margin-bottom: 10px;
}

/* PESO ‚Äì card violeta */
.card-weight {
  border-color: #6366f1;
  box-shadow: 0 0 0 1px rgba(99,102,241,0.20);
}
.weight-title {
  color: #818cf8;
}

/* CARDIO ‚Äì card ciano */
.card-cardio {
  background: radial-gradient(circle at top, #0f172a 0, #020617 80%);
  border-color: #0ea5e9;
  box-shadow: 0 0 0 1px rgba(14,165,233,0.25);
}
.cardio-title {
  color: #38bdf8;
}

.exercise-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
}
.exercise-title {
  font-size: 14px;
  font-weight: 600;
}
.exercise-sub {
  font-size: 11px;
  color: #9ca3af;
}

/* badges */
.pill {
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 10px;
  border: 1px solid #4b5563;
}
.badge-weight {
  border-color: #6366f1;
}
.badge-cardio {
  border-color: #0ea5e9;
}

/* Form fields */
.exercise-fields {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
@media (max-width: 640px) {
  .exercise-fields {
    grid-template-columns: 1fr;
  }
}

.field-block {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.bottom-row {
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* --- META DA CORRIDA --- */
.run-meta {
  border: 1px solid #0ea5e9;
  background: rgba(14,165,233,0.06);
  padding: 8px;
  border-radius: 10px;
  margin-bottom: 10px;
}
.run-meta-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.run-meta-grid {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 8px;
}
@media (max-width: 500px) {
  .run-meta-grid {
    grid-template-columns: 1fr;
  }
}
.run-meta-item {
  font-size: 12px;
}
.run-meta-item b {
  font-size: 12px;
  color: #7dd3fc;
}

/* CARDIO RESUMO */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(2,minmax(0,1fr));
  gap: 10px;
}
@media (max-width: 640px) {
  .summary-grid {
    grid-template-columns: 1fr;
  }
}
.summary-box {
  border-radius: 10px;
  border: 1px solid #1f2937;
  padding: 10px;
}
.summary-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
}

/* ---------- ALIMENTA√á√ÉO ---------- */
.meal-block {
  border: 1px solid #1f2937;
  border-radius: 10px;
  padding: 8px;
  margin-bottom: 6px;
}
.meal-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.shopping-category-title {
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 6px;
}
.shopping-item {
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}
</style>
</head>

<body>
<header>
  <h1>Guerra Fit</h1>
  <small>Treinos, corrida e alimenta√ß√£o ‚Äî semana iniciando na ter√ßa.</small>
</header>

<main>

<!-- ------------------ NAVEGA√á√ÉO PRINCIPAL ------------------ -->
<div class="card">
  <div class="top-tabs">
    <button class="top-tab-btn active" data-main="treino">Treinos</button>
    <button class="top-tab-btn" data-main="alim">Alimenta√ß√£o</button>
  </div>
</div>

<!-- ------------------ VIEW: TREINO ------------------ -->
<div id="view-treino">

  <div class="card">
    <div class="row">
      <div class="col-6">
        <label>Arquivo de treinos (.csv)</label>
        <input type="file" id="csvInput" accept=".csv">
      </div>
      <div class="col-6">
        <label>Dia do treino</label>
        <select id="diaSelect"></select>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col-6">
        <label>Data</label>
        <input type="date" id="dataInput">
      </div>
      <div class="col-6">
        <div class="help-text" style="padding-top:6px;">
          Todos os dados s√£o salvos automaticamente no navegador.
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col-6"><button class="primary" id="btnExport">Exportar dados (.json)</button></div>
      <div class="col-6"><button id="btnReset">Limpar dados deste dia</button></div>
    </div>

    <div id="statusArea" class="help-text" style="margin-top:6px;">Nenhum treino carregado ainda.</div>
  </div>

  <div class="card">
    <div class="tabs-treino" style="display:flex; gap:6px;">
      <button class="tab-btn-treino active" data-tab="dia">Treino do dia</button>
      <button class="tab-btn-treino" data-tab="cardio">Cardio ‚Äî dia / semana</button>
    </div>

    <!-- Conte√∫do: Treino do dia -->
    <div id="tab-dia">
      <div id="diaInfo" class="help-text" style="margin-bottom:8px;"></div>
      <div id="diaContainer"></div>
    </div>

    <!-- Conte√∫do: Cardio -->
    <div id="tab-cardio" class="hidden">
      <div class="summary-grid">
        <div class="summary-box">
          <div class="summary-title">Cardio do dia</div>
          <div id="cardioDiaResumo"></div>
        </div>
        <div class="summary-box">
          <div class="summary-title">Cardio √∫ltimos 7 dias</div>
          <div id="cardioSemanaResumo"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ------------------ VIEW: ALIMENTA√á√ÉO ------------------ -->
<div id="view-alim" class="hidden">
  <div class="card">
    <div class="tabs-alim" style="display:flex; gap:6px;">
      <button class="tab-btn-alim active" data-tab="alim-dia">Card√°pio do dia</button>
      <button class="tab-btn-alim" data-tab="alim-semana">Semana</button>
      <button class="tab-btn-alim" data-tab="alim-compras">Lista de compras</button>
    </div>

    <div id="alim-dia">
      <div id="alimDiaInfo" class="help-text" style="margin-bottom:8px;"></div>
      <div id="alimDiaContainer"></div>
    </div>

    <div id="alim-semana" class="hidden">
      <div id="alimSemanaContainer"></div>
    </div>

    <div id="alim-compras" class="hidden">
      <div id="shoppingContainer"></div>
    </div>
  </div>
</div>

<script>
/* =====================
   CONFIGURA√á√ÉO B√ÅSICA
   ===================== */
const STORAGE_KEY = "guerra_fit_logs_v1";
const SHOPPING_KEY = "guerra_fit_shopping_v1";

let baseExercises = [];   // vindo do CSV
let dailyLog = {};        // dados salvos no navegador

function todayISO() {
  const d = new Date();
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off * 60000);
  return local.toISOString().slice(0, 10);
}

function loadDailyLog() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    dailyLog = raw ? JSON.parse(raw) : {};
  } catch (e) {
    dailyLog = {};
  }
}
function saveDailyLog() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(dailyLog));
}

function setStatus(msg) {
  const el = document.getElementById("statusArea");
  if (el) el.textContent = msg;
}

/* =====================
   CSV / TREINOS
   ===================== */
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (lines.length < 2) return [];
  let delimiter = ";";
  if (lines[0].includes(",") && !lines[0].includes(";")) delimiter = ",";
  const headers = lines[0].split(delimiter).map(h => h.trim());

  function getVal(cells, name) {
    const idx = headers.indexOf(name);
    return idx === -1 ? "" : (cells[idx] || "").trim();
  }

  const result = [];
  for (let i = 1; i < lines.length; i++) {
    const cells = lines[i].split(delimiter);
    const row = {
      dia:        getVal(cells, "Dia"),
      grupo:      getVal(cells, "Grupo"),
      exercicio:  getVal(cells, "Exerc√≠cio"),
      tipo:       getVal(cells, "Tipo"),
      series:     getVal(cells, "S√©ries"),
      repsTempo:  getVal(cells, "Reps/Tempo"),
      rpeZona:    getVal(cells, "RPE/Zona"),
      aquecimento:getVal(cells, "Aquecimento?"),
      midia:      getVal(cells, "Link v√≠deo")
    };
    if (Object.values(row).every(v => !v)) continue;
    result.push(row);
  }
  return result;
}

function rebuildDiaOptions() {
  const sel = document.getElementById("diaSelect");
  if (!sel) return;

  const dias = Array.from(new Set(baseExercises.map(e => (e.dia || "").trim())))
    .filter(Boolean);

  const ordem = ["Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo","Segunda"];
  dias.sort((a,b) => {
    const ia = ordem.indexOf(a);
    const ib = ordem.indexOf(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b);
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Selecione o dia";
  sel.appendChild(opt0);
  dias.forEach(d => {
    const o = document.createElement("option");
    o.value = d;
    o.textContent = d;
    sel.appendChild(o);
  });

  const mapaSemana = {
    0: "Domingo",
    1: "Segunda",
    2: "Ter√ßa",
    3: "Quarta",
    4: "Quinta",
    5: "Sexta",
    6: "S√°bado"
  };
  const hoje = mapaSemana[new Date().getDay()];
  if (dias.includes(hoje)) sel.value = hoje;
}

/* =====================
   LOG POR EXERC√çCIO
   ===================== */
function getDiaSelecionado() {
  const sel = document.getElementById("diaSelect");
  return sel && sel.value ? sel.value : "";
}
function getDataSelecionada() {
  const inp = document.getElementById("dataInput");
  return inp && inp.value ? inp.value : todayISO();
}

function keyFor(exId, dateStr) {
  return exId + "::" + dateStr;
}

function getLog(exId, dateStr) {
  const key = keyFor(exId, dateStr);
  if (!dailyLog[key]) {
    dailyLog[key] = {
      peso: "",
      rpePercebido: "",
      carga1: "",
      carga2: "",
      carga3: "",
      carga4: "",
      tempoCardioMin: "",
      distCardioKm: "",
      cardioTipo: "",
      obs: "",
      concluido: false
    };
  }
  return dailyLog[key];
}

function updateLogField(exId, field, value) {
  const date = getDataSelecionada();
  const log = getLog(exId, date);
  log[field] = value;
  dailyLog[keyFor(exId, date)] = log;
  saveDailyLog();
  updateCardioSummary();
}
function updateLogCheckbox(exId, field, checked) {
  updateLogField(exId, field, !!checked);
}

/* =====================
   RENDER: TREINO DO DIA
   ===================== */
function renderDia() {
  const container = document.getElementById("diaContainer");
  const info = document.getElementById("diaInfo");
  if (!container || !info) return;

  container.innerHTML = "";

  if (!baseExercises.length) {
    info.textContent = "Carregue um arquivo de treinos (.csv) para come√ßar.";
    return;
  }

  const diaSel = getDiaSelecionado();
  const dataSel = getDataSelecionada();
  if (!diaSel) {
    info.textContent = "Selecione o dia do treino.";
    return;
  }

  info.textContent = "Treino de " + diaSel + " em " + dataSel + ".";
  const listaDia = baseExercises.filter(e => (e.dia || "").trim() === diaSel);

  if (!listaDia.length) {
    container.innerHTML = "<div class='help-text'>Nenhum exerc√≠cio configurado para este dia.</div>";
    return;
  }

  listaDia.forEach((ex, idx) => {
    const exId = "ex_" + idx + "_" + diaSel;
    const log = getLog(exId, dataSel);

    const grupoLower = (ex.grupo || "").toLowerCase();
    const tipoLower  = (ex.tipo  || "").toLowerCase();

    const isCorrida = grupoLower.includes("corrida");
    const isCardio  = isCorrida ||
                      grupoLower.includes("aquecimento") ||
                      grupoLower.includes("recupera√ß√£o") ||
                      tipoLower.includes("cardio");
    const isPeso    = !isCardio;

    const card = document.createElement("div");
    card.className = "exercise-card";
    if (isCardio) card.classList.add("card-cardio");
    if (isPeso)   card.classList.add("card-weight");

    /* Cabe√ßalho */
    const header = document.createElement("div");
    header.className = "exercise-header";

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.className = "exercise-title";
    if (isCardio) title.classList.add("cardio-title");
    if (isPeso)   title.classList.add("weight-title");

    const icon = isCardio ? "üèÉ " : "üèãÔ∏è ";
    title.textContent = icon + (ex.exercicio || "");

    const sub = document.createElement("div");
    sub.className = "exercise-sub";
    sub.textContent = (ex.grupo || "") + (ex.tipo ? " ‚Ä¢ " + ex.tipo : "");

    left.appendChild(title);
    left.appendChild(sub);
    header.appendChild(left);

    const badge = document.createElement("div");
    badge.className = "pill";
    if (isCardio) badge.classList.add("badge-cardio");
    if (isPeso)   badge.classList.add("badge-weight");

    badge.textContent = ex.repsTempo + (ex.rpeZona ? " ¬∑ " + ex.rpeZona : "");
    header.appendChild(badge);

    card.appendChild(header);

    /* Meta da corrida ‚Äì s√≥ para corrida principal */
    if (isCorrida) {
      const meta = document.createElement("div");
      meta.className = "run-meta";

      meta.innerHTML = `
        <div class="run-meta-title">
          <span>üèÉ</span><span>Meta da corrida</span>
        </div>
        <div class="run-meta-grid">
          <div class="run-meta-item">
            <b>Tempo alvo</b>
            <span>${ex.repsTempo || "‚Äî"}</span>
          </div>
          <div class="run-meta-item">
            <b>Dist√¢ncia / descri√ß√£o</b>
            <span>${ex.repsTempo.includes("alvo") ? ex.repsTempo : "Conforme plano"}</span>
          </div>
          <div class="run-meta-item">
            <b>Intensidade</b>
            <span>${ex.rpeZona || "‚Äî"}</span>
          </div>
        </div>
      `;
      card.appendChild(meta);
    }

    /* Campos */
    const fields = document.createElement("div");
    fields.className = "exercise-fields";

    // peso
    const fbPeso = document.createElement("div");
    fbPeso.className = "field-block";
    fbPeso.innerHTML = `
      <label>Peso corporal (kg)</label>
      <input type="number" step="0.1" value="${log.peso || ""}">
    `;
    fbPeso.querySelector("input").onchange = e =>
      updateLogField(exId, "peso", e.target.value);
    fields.appendChild(fbPeso);

    // RPE percebido
    const fbRPE = document.createElement("div");
    fbRPE.className = "field-block";
    fbRPE.innerHTML = `
      <label>RPE percebido (1‚Äì10)</label>
      <input type="number" step="0.5" min="1" max="10" value="${log.rpePercebido || ""}">
    `;
    fbRPE.querySelector("input").onchange = e =>
      updateLogField(exId, "rpePercebido", e.target.value);
    fields.appendChild(fbRPE);

    // Cargas (para peso e aquecimentos de for√ßa)
    if (!isCardio || (isCardio && !isCorrida)) {
      const fbCarga = document.createElement("div");
      fbCarga.className = "field-block";
      fbCarga.innerHTML = `<label>Cargas (S1‚ÄìS4)</label>`;
      const wrap = document.createElement("div");
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "repeat(4, minmax(0,1fr))";
      wrap.style.gap = "4px";
      ["carga1","carga2","carga3","carga4"].forEach((field,i) => {
        const inp = document.createElement("input");
        inp.type = "number";
        inp.step = "0.5";
        inp.placeholder = "S" + (i+1);
        inp.value = log[field] || "";
        inp.onchange = e => updateLogField(exId, field, e.target.value);
        wrap.appendChild(inp);
      });
      fbCarga.appendChild(wrap);
      fields.appendChild(fbCarga);
    }

    // Campos espec√≠ficos de corrida
    if (isCorrida) {
      const fbTipo = document.createElement("div");
      fbTipo.className = "field-block";
      fbTipo.innerHTML = `
        <label>Tipo de corrida</label>
        <select>
          <option value="">Selecione</option>
          <option value="Esteira">Esteira</option>
          <option value="Rua">Rua/Outdoor</option>
        </select>
      `;
      fbTipo.querySelector("select").value = log.cardioTipo || "";
      fbTipo.querySelector("select").onchange = e =>
        updateLogField(exId, "cardioTipo", e.target.value);
      fields.appendChild(fbTipo);

      const fbTempo = document.createElement("div");
      fbTempo.className = "field-block";
      fbTempo.innerHTML = `
        <label>Tempo realizado (min)</label>
        <input type="number" step="1" value="${log.tempoCardioMin || ""}">
      `;
      fbTempo.querySelector("input").onchange = e =>
        updateLogField(exId, "tempoCardioMin", e.target.value);
      fields.appendChild(fbTempo);

      const fbDist = document.createElement("div");
      fbDist.className = "field-block";
      fbDist.innerHTML = `
        <label>Dist√¢ncia realizada (km)</label>
        <input type="number" step="0.1" value="${log.distCardioKm || ""}">
      `;
      fbDist.querySelector("input").onchange = e =>
        updateLogField(exId, "distCardioKm", e.target.value);
      fields.appendChild(fbDist);
    }

    // Observa√ß√µes
    const fbObs = document.createElement("div");
    fbObs.className = "field-block";
    fbObs.innerHTML = `
      <label>Observa√ß√µes</label>
      <textarea>${log.obs || ""}</textarea>
    `;
    fbObs.querySelector("textarea").onchange = e =>
      updateLogField(exId, "obs", e.target.value);
    fields.appendChild(fbObs);

    card.appendChild(fields);

    /* Rodap√© */
    const bottom = document.createElement("div");
    bottom.className = "bottom-row";

    const lblChk = document.createElement("label");
    lblChk.style.fontSize = "11px";
    lblChk.innerHTML = `<input type="checkbox" ${log.concluido ? "checked" : ""}> Exerc√≠cio conclu√≠do`;
    lblChk.querySelector("input").onchange = e =>
      updateLogCheckbox(exId, "concluido", e.target.checked);
    bottom.appendChild(lblChk);

    if (ex.midia) {
      const btn = document.createElement("button");
      btn.textContent = "V√≠deo / imagem";
      btn.onclick = () => window.open(ex.midia, "_blank");
      bottom.appendChild(btn);
    }

    card.appendChild(bottom);
    container.appendChild(card);
  });

  updateCardioSummary();
}

/* =====================
   CARDIO RESUMO (DIA / SEMANA)
   ===================== */
function updateCardioSummary() {
  const diaSel = getDiaSelecionado();
  const dataSel = getDataSelecionada();
  const diaDiv  = document.getElementById("cardioDiaResumo");
  const semDiv  = document.getElementById("cardioSemanaResumo");
  if (!diaDiv || !semDiv) return;

  if (!baseExercises.length || !diaSel) {
    diaDiv.textContent = "Nenhum treino selecionado.";
    semDiv.textContent = "Nenhum dado dispon√≠vel.";
    return;
  }

  /* --- Dia --- */
  let totalMinDia = 0;
  let totalKmDia  = 0;

  Object.keys(dailyLog).forEach(key => {
    const [exId, data] = key.split("::");
    if (data !== dataSel) return;
    const log = dailyLog[key];

    const match = exId.match(/^ex_(\d+)_/);
    if (!match) return;
    const idx = parseInt(match[1], 10);

    const exList = baseExercises.filter(e => (e.dia || "").trim() === diaSel);
    const ex = exList[idx];
    if (!ex) return;

    const grupoLower = (ex.grupo || "").toLowerCase();
    const tipoLower  = (ex.tipo  || "").toLowerCase();
    const isCardio = grupoLower.includes("corrida") ||
                     grupoLower.includes("aquecimento") ||
                     grupoLower.includes("recupera√ß√£o") ||
                     tipoLower.includes("cardio");
    if (!isCardio) return;

    const min = parseFloat(log.tempoCardioMin || "0") || 0;
    const km  = parseFloat(log.distCardioKm   || "0") || 0;
    totalMinDia += min;
    totalKmDia  += km;
  });

  if (totalMinDia > 0 || totalKmDia > 0) {
    let pace = "";
    if (totalMinDia > 0 && totalKmDia > 0) {
      pace = " ¬∑ " + (totalMinDia / totalKmDia).toFixed(1) + " min/km";
    }
    diaDiv.textContent =
      totalMinDia.toFixed(0) + " min ¬∑ " + totalKmDia.toFixed(2) + " km" + pace;
  } else {
    diaDiv.textContent = "Nenhum registro de cardio para esta data.";
  }

  /* --- Semana (√∫ltimos 7 dias) --- */
  let totalMinSem = 0;
  let totalKmSem  = 0;
  const baseDate = new Date(dataSel);

  Object.keys(dailyLog).forEach(key => {
    const [exId, data] = key.split("::");
    const d = new Date(data);
    const diff = (baseDate - d) / (1000*60*60*24);
    if (diff < 0 || diff > 7) return;

    const log = dailyLog[key];
    const match = exId.match(/^ex_(\d+)_([^:]+)$/);
    if (!match) return;
    const idx = parseInt(match[1], 10);
    const diaEx = match[2];

    const exList = baseExercises.filter(e => (e.dia || "").trim() === diaEx);
    const ex = exList[idx];
    if (!ex) return;

    const grupoLower = (ex.grupo || "").toLowerCase();
    const tipoLower  = (ex.tipo  || "").toLowerCase();
    const isCardio = grupoLower.includes("corrida") ||
                     grupoLower.includes("aquecimento") ||
                     grupoLower.includes("recupera√ß√£o") ||
                     tipoLower.includes("cardio");
    if (!isCardio) return;

    const min = parseFloat(log.tempoCardioMin || "0") || 0;
    const km  = parseFloat(log.distCardioKm   || "0") || 0;
    totalMinSem += min;
    totalKmSem  += km;
  });

  if (totalMinSem > 0 || totalKmSem > 0) {
    let pace = "";
    if (totalMinSem > 0 && totalKmSem > 0) {
      pace = " ¬∑ " + (totalMinSem / totalKmSem).toFixed(1) + " min/km";
    }
    semDiv.textContent =
      totalMinSem.toFixed(0) + " min ¬∑ " + totalKmSem.toFixed(2) + " km" + pace;
  } else {
    semDiv.textContent = "Nenhum registro de cardio nos √∫ltimos 7 dias.";
  }
}

/* =====================
   EXPORT / RESET
   ===================== */
function exportJson() {
  const data = JSON.stringify(dailyLog, null, 2);
  const blob = new Blob([data], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "guerra_fit_logs.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus("Exportado guerra_fit_logs.json.");
}

function resetDia() {
  const diaSel = getDiaSelecionado();
  const dataSel = getDataSelecionada();
  if (!diaSel) return;

  const novo = {};
  Object.keys(dailyLog).forEach(key => {
    const [exId, data] = key.split("::");
    if (data === dataSel) return; // descarta este dia
    novo[key] = dailyLog[key];
  });
  dailyLog = novo;
  saveDailyLog();
  renderDia();
  setStatus("Dados de " + dataSel + " limpos.");
}
/* =====================
   ALIMENTA√á√ÉO / LISTA DE COMPRAS
   ===================== */

const shoppingItems = [
  // Prote√≠nas
  { id: "frango",    label: "Peito de frango (2‚Äì3kg)",           category: "Prote√≠nas" },
  { id: "ovos",      label: "Ovos (36 unidades)",                category: "Prote√≠nas" },
  { id: "carne",     label: "Carne vermelha magra (1‚Äì2kg)",      category: "Prote√≠nas" },
  { id: "peixe",     label: "Peixe (1kg)",                       category: "Prote√≠nas" },
  { id: "iogurte",   label: "Iogurte natural/greco s/ a√ß√∫car",   category: "Prote√≠nas" },
  { id: "cottage",   label: "Cottage / ricota (500g)",           category: "Prote√≠nas" },

  // Carbo
  { id: "arrozint",  label: "Arroz integral (2kg)",              category: "Carboidratos" },
  { id: "batata",    label: "Batata doce (2,5kg)",               category: "Carboidratos" },
  { id: "aveia",     label: "Aveia em flocos (1kg)",             category: "Carboidratos" },
  { id: "pao",       label: "P√£o integral 100% (2 pacotes)",     category: "Carboidratos" },
  { id: "banana",    label: "Banana (14 unid.)",                 category: "Carboidratos" },
  { id: "maca",      label: "Ma√ß√£ (7 unid.)",                    category: "Carboidratos" },

  // Verduras / legumes
  { id: "folhas",    label: "Folhas verdes (3 pacotes)",         category: "Verduras/Legumes" },
  { id: "brocolis",  label: "Br√≥colis (2 cabe√ßas)",              category: "Verduras/Legumes" },
  { id: "abobrinha", label: "Abobrinha (4 unid.)",               category: "Verduras/Legumes" },
  { id: "cenoura",   label: "Cenoura (1kg)",                     category: "Verduras/Legumes" },
  { id: "tomate",    label: "Tomate (1,5kg)",                    category: "Verduras/Legumes" },

  // Gorduras boas
  { id: "azeite",    label: "Azeite extra virgem (500ml)",       category: "Gorduras boas" },
  { id: "castanhas", label: "Castanhas/nozes (600g)",            category: "Gorduras boas" },
  { id: "abacate",   label: "Abacate (4 unid.)",                 category: "Gorduras boas" },
  { id: "pastaam",   label: "Pasta de amendoim (450g)",          category: "Gorduras boas" },

  // Suporte
  { id: "agua",      label: "√Ågua (gal√µes/garrafas p/ semana)",  category: "Suporte" },
  { id: "cafe",      label: "Caf√© / ch√°s sem a√ß√∫car",            category: "Suporte" }
];

function loadShopping() {
  const cont = document.getElementById("shoppingContainer");
  if (!cont) return;
  let state = {};
  try {
    const raw = localStorage.getItem(SHOPPING_KEY);
    state = raw ? JSON.parse(raw) : {};
  } catch (e) {
    state = {};
  }

  cont.innerHTML = "";
  const byCat = {};
  shoppingItems.forEach(item => {
    if (!byCat[item.category]) byCat[item.category] = [];
    byCat[item.category].push(item);
  });

  Object.keys(byCat).forEach(cat => {
    const catDiv = document.createElement("div");
    const title = document.createElement("div");
    title.className = "shopping-category-title";
    title.textContent = cat;
    catDiv.appendChild(title);

    byCat[cat].forEach(item => {
      const row = document.createElement("div");
      row.className = "shopping-item";
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = !!state[item.id];
      chk.onchange = e => {
        state[item.id] = e.target.checked;
        localStorage.setItem(SHOPPING_KEY, JSON.stringify(state));
      };
      const span = document.createElement("span");
      span.textContent = item.label;

      row.appendChild(chk);
      row.appendChild(span);
      catDiv.appendChild(row);
    });

    cont.appendChild(catDiv);
  });
}

/* ---------- Card√°pio do dia ---------- */
function renderCardapioDia() {
  const info = document.getElementById("alimDiaInfo");
  const cont = document.getElementById("alimDiaContainer");
  if (!info || !cont) return;

  const diaSel = getDiaSelecionado() || "dia padr√£o";
  const dataSel = getDataSelecionada();

  info.textContent = "Sugest√£o r√°pida para " + diaSel + " (" + dataSel + "). Depois refinamos macros refei√ß√£o a refei√ß√£o.";

  let tipoDia = "musculacao";
  if (diaSel === "S√°bado" || diaSel === "Domingo") tipoDia = "corrida";
  if (diaSel === "Quinta") tipoDia = "leve";

  const blocos = [];

  if (tipoDia === "musculacao") {
    blocos.push({
      titulo: "Caf√© da manh√£",
      texto: "Ovos + aveia + fruta (banana/ma√ß√£) + caf√© sem a√ß√∫car. Base proteica + carbo limpo."
    });
    blocos.push({
      titulo: "Almo√ßo",
      texto: "Frango/carne magra + arroz integral ou batata doce + bastante salada e legumes."
    });
    blocos.push({
      titulo: "Lanche pr√©-treino",
      texto: "P√£o integral + pasta de amendoim OU banana + caf√©. Foco em energia p/ treino."
    });
    blocos.push({
      titulo: "Jantar",
      texto: "Peixe ou frango + legumes + salada. Carbo moderado, prote√≠na alta."
    });
    blocos.push({
      titulo: "Ceia",
      texto: "Iogurte + castanhas ou cottage. Prote√≠na + gordura boa para saciedade."
    });
  } else if (tipoDia === "corrida") {
    blocos.push({
      titulo: "Pr√©-corrida",
      texto: "Banana + mel OU p√£o integral com geleia. 30‚Äì60min antes da corrida."
    });
    blocos.push({
      titulo: "P√≥s-corrida",
      texto: "Iogurte + fruta + um pouco de aveia. Repor carbo + prote√≠na leve."
    });
    blocos.push({
      titulo: "Refei√ß√µes principais",
      texto: "Frango/peixe + arroz integral/batata + legumes. Aten√ß√£o √† hidrata√ß√£o."
    });
  } else {
    blocos.push({
      titulo: "Dia leve",
      texto: "Manter prote√≠na alta em todas as refei√ß√µes, carbo moderado e muitas fibras."
    });
  }

  cont.innerHTML = "";
  blocos.forEach(b => {
    const div = document.createElement("div");
    div.className = "meal-block";
    const t = document.createElement("div");
    t.className = "meal-title";
    t.textContent = b.titulo;
    const p = document.createElement("div");
    p.textContent = b.texto;
    div.appendChild(t);
    div.appendChild(p);
    cont.appendChild(div);
  });
}

/* ---------- Card√°pio da semana (texto geral) ---------- */
function renderCardapioSemana() {
  const cont = document.getElementById("alimSemanaContainer");
  if (!cont) return;
  cont.innerHTML = `
    <p>Estrutura alvo (~2.200‚Äì2.400 kcal/dia, 160‚Äì180g de prote√≠na):</p>
    <ul>
      <li>Prote√≠na em todas as refei√ß√µes principais (frango, carne magra, peixe, ovos, iogurte).</li>
      <li>Carboidratos concentrados perto de treino/corrida (arroz, batata doce, p√£o integral, aveia).</li>
      <li>Muitas fibras: verduras e legumes em pelo menos 2 refei√ß√µes por dia.</li>
      <li>Gorduras boas moderadas (azeite, castanhas, abacate, pasta de amendoim).</li>
      <li>Hidrata√ß√£o alta, especialmente nos dias de corrida.</li>
    </ul>
    <p>Depois podemos trocar este bloco por um card√°pio completo refei√ß√£o a refei√ß√£o (Ter√ßa a Domingo) com quantidades.</p>
  `;
}

/* =====================
   TABS / INICIALIZA√á√ÉO
   ===================== */

function initMainTabs() {
  const mainBtns = document.querySelectorAll(".top-tab-btn");
  const viewTreino = document.getElementById("view-treino");
  const viewAlim   = document.getElementById("view-alim");

  mainBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      mainBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.main;
      if (target === "treino") {
        viewTreino.classList.remove("hidden");
        viewAlim.classList.add("hidden");
      } else {
        viewTreino.classList.add("hidden");
        viewAlim.classList.remove("hidden");
      }
    });
  });
}

function initTreinoTabs() {
  const btns = document.querySelectorAll(".tab-btn-treino");
  const tabDia = document.getElementById("tab-dia");
  const tabCardio = document.getElementById("tab-cardio");

  btns.forEach(btn => {
    btn.addEventListener("click", () => {
      btns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      if (tab === "dia") {
        tabDia.classList.remove("hidden");
        tabCardio.classList.add("hidden");
      } else {
        tabDia.classList.add("hidden");
        tabCardio.classList.remove("hidden");
      }
    });
  });
}

function initAlimTabs() {
  const btns = document.querySelectorAll(".tab-btn-alim");
  const d = document.getElementById("alim-dia");
  const s = document.getElementById("alim-semana");
  const c = document.getElementById("alim-compras");

  btns.forEach(btn => {
    btn.addEventListener("click", () => {
      btns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      d.classList.add("hidden");
      s.classList.add("hidden");
      c.classList.add("hidden");
      if (tab === "alim-dia") d.classList.remove("hidden");
      if (tab === "alim-semana") s.classList.remove("hidden");
      if (tab === "alim-compras") c.classList.remove("hidden");
    });
  });
}

/* ---------- DOMContentLoaded ---------- */
document.addEventListener("DOMContentLoaded", () => {
  loadDailyLog();

  // data hoje
  const dataInput = document.getElementById("dataInput");
  if (dataInput && !dataInput.value) {
    dataInput.value = todayISO();
  }

  // Tabs
  initMainTabs();
  initTreinoTabs();
  initAlimTabs();

  // Alimenta√ß√£o
  loadShopping();
  renderCardapioSemana();
  renderCardapioDia();

  // CSV input
  const csvInput = document.getElementById("csvInput");
  if (csvInput) {
    csvInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          baseExercises = parseCSV(ev.target.result);
          setStatus("Arquivo carregado com " + baseExercises.length + " linhas.");
          rebuildDiaOptions();
          renderDia();
          renderCardapioDia();
        } catch (err) {
          console.error(err);
          setStatus("Erro ao ler arquivo de treinos.");
        }
      };
      reader.readAsText(file, "utf-8");
    });
  }

  // Mudan√ßas de dia/data
  const diaSelect = document.getElementById("diaSelect");
  if (diaSelect) {
    diaSelect.addEventListener("change", () => {
      renderDia();
      renderCardapioDia();
    });
  }
  if (dataInput) {
    dataInput.addEventListener("change", () => {
      renderDia();
      renderCardapioDia();
    });
  }

  // Export / reset
  const btnExport = document.getElementById("btnExport");
  if (btnExport) btnExport.addEventListener("click", exportJson);

  const btnReset = document.getElementById("btnReset");
  if (btnReset) btnReset.addEventListener("click", resetDia);
});
</script>
</body>
</html>
