<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Guerra Fit ‚Äì Treinos, corrida e alimenta√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #000000;
      color: #f9fafb;
    }
    header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #111827, #020617 65%);
    }
    header h1 {
      margin: 0 0 4px 0;
      font-size: 20px;
      font-weight: 700;
    }
    header small {
      color: #9ca3af;
      font-size: 12px;
    }
    main {
      padding: 10px;
      max-width: 960px;
      margin: 0 auto 40px auto;
    }

    .card {
      background: #05050a;
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px;
      margin-bottom: 14px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .col-6 {
      flex: 1 1 260px;
      min-width: 0;
    }

    label {
      font-size: 12px;
      margin-bottom: 3px;
      display: block;
    }
    input,
    select,
    textarea {
      width: 100%;
      background: #020617;
      border-radius: 12px;
      border: 1px solid #374151;
      padding: 8px 10px;
      color: #f9fafb;
      font-size: 13px;
    }
    input[type="file"] {
      padding: 6px 10px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    button.primary {
      background: #0a84ff;
      border-color: #0a84ff;
    }
    .help-text {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Tabs principais */
    .top-tabs {
      display: flex;
      gap: 8px;
    }
    .top-tab-btn {
      flex: 1;
      padding: 10px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
      font-size: 14px;
      font-weight: 500;
    }
    .top-tab-btn.active {
      background: #34c759;
      border-color: #34c759;
      color: #000000;
    }

    /* Tabs internas */
    .tab-strip {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
      font-size: 13px;
    }
    .tab-btn.active {
      background: #0a84ff;
      border-color: #0a84ff;
      color: #ffffff;
    }

    .hidden { display: none; }

    /* Exerc√≠cios */
    .exercise-card {
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px;
      margin-bottom: 10px;
      background: #020617;
    }

    /* For√ßa / muscula√ß√£o ‚Äì vermelho */
    .card-strength {
      border-color: #ff3b30;
      box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.18);
    }
    .strength-title { color: #ff453a; }
    .badge-strength {
      border-color: #ff3b30;
      color: #ff9f9a;
    }

    /* Cardio / corrida / recupera√ß√£o ‚Äì verde */
    .card-cardio {
      background: radial-gradient(circle at top left, #022c22, #020617 70%);
      border-color: #00ff9d;
      box-shadow: 0 0 0 1px rgba(0, 255, 157, 0.22);
    }
    .cardio-title { color: #00ff9d; }
    .badge-cardio {
      border-color: #00ff9d;
      color: #bbf7d0;
    }

    /* Aquecimento ‚Äì azul */
    .card-warmup {
      background: radial-gradient(circle at top left, #0b1120, #020617 70%);
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.22);
    }
    .warmup-title { color: #60a5fa; }
    .badge-warmup {
      border-color: #3b82f6;
      color: #bfdbfe;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .exercise-title {
      font-size: 14px;
      font-weight: 600;
    }
    .exercise-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    .exercise-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .exercise-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }
    @media (max-width: 640px) {
      .exercise-fields { grid-template-columns: 1fr; }
    }
    .field-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .bottom-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 11px;
    }

    /* Meta corrida */
    .run-meta {
      border-radius: 12px;
      border: 1px solid #00ff9d;
      background: rgba(16, 185, 129, 0.12);
      padding: 8px;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .run-meta-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #a7f3d0;
    }
    .run-meta-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }
    @media (max-width: 640px) {
      .run-meta-grid { grid-template-columns: 1fr; }
    }
    .run-meta-item {
      font-size: 11px;
      color: #d1fae5;
    }
    .run-meta-item b {
      display: block;
      font-size: 11px;
      color: #86efac;
    }

    /* Resumo cardio */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 640px) {
      .summary-grid { grid-template-columns: 1fr; }
    }
    .summary-box {
      border-radius: 12px;
      border: 1px solid #111827;
      padding: 10px;
      background: #020617;
    }
    .summary-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* Alimenta√ß√£o */
    .meal-block {
      border-radius: 12px;
      border: 1px solid #111827;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #020617;
      font-size: 13px;
    }
    .meal-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .shopping-category-title {
      font-weight: 600;
      margin: 12px 0 4px 0;
      font-size: 13px;
    }
    .shopping-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin-bottom: 3px;
    }
    #shoppingContainer {
      padding-top: 4px;
    }

    #statusArea {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <header>
    <h1>Guerra Fit</h1>
    <small>Treinos, corrida e alimenta√ß√£o ‚Äî semana iniciando na segunda-feira.</small>
  </header>

  <main>
    <!-- Tabs principais -->
    <div class="card">
      <div class="top-tabs">
        <button class="top-tab-btn active" data-main="treino">Treinos</button>
        <button class="top-tab-btn" data-main="alimentacao">Alimenta√ß√£o</button>
      </div>
    </div>

    <!-- VIEW TREINO -->
    <div id="view-treino">
      <div class="card">
        <div class="row">
          <div class="col-6">
            <label>Arquivo de treinos (.csv)</label>
            <input type="file" id="csvInput" accept=".csv" />
          </div>
          <div class="col-6">
            <label>Dia do treino</label>
            <select id="diaSelect"></select>
          </div>
        </div>

        <div class="row" style="margin-top: 8px;">
          <div class="col-6">
            <label>Data</label>
            <input type="date" id="dataInput" />
          </div>
          <div class="col-6">
            <div class="help-text" style="padding-top: 9px;">
              Todos os dados (peso, cargas, corrida, RPE) s√£o salvos automaticamente no navegador.
            </div>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col-6">
            <button id="btnExport" class="primary">Exportar dados (.json)</button>
          </div>
          <div class="col-6">
            <button id="btnReset">Limpar dados deste dia</button>
          </div>
        </div>

        <div id="statusArea">Nenhum treino carregado ainda.</div>
      </div>

      <div class="card">
        <div class="tab-strip">
          <button class="tab-btn active" data-tab-treino="dia">Treino do dia</button>
          <button class="tab-btn" data-tab-treino="cardio">Cardio ‚Äî dia / semana</button>
        </div>

        <div id="tab-dia">
          <div id="diaInfo" class="help-text" style="margin-bottom: 6px;"></div>
          <div id="diaContainer"></div>
        </div>

        <div id="tab-cardio" class="hidden">
          <div class="summary-grid">
            <div class="summary-box">
              <div class="summary-title">Cardio do dia</div>
              <div id="cardioDiaResumo" class="help-text"></div>
            </div>
            <div class="summary-box">
              <div class="summary-title">Cardio √∫ltimos 7 dias</div>
              <div id="cardioSemanaResumo" class="help-text"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW ALIMENTA√á√ÉO -->
    <div id="view-alimentacao" class="hidden">
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <div class="col-6">
            <label>Arquivo de alimenta√ß√£o (.csv)</label>
            <input type="file" id="alimCsvInput" accept=".csv" />
          </div>
          <div class="col-6">
            <div class="help-text" style="padding-top: 9px;">
              Formato: Dia;Refei√ß√£o;Item;Quantidade;Unidade;Grupo.
            </div>
          </div>
        </div>

        <div class="tab-strip">
          <button class="tab-btn active" data-tab-alim="dia">Card√°pio do dia</button>
          <button class="tab-btn" data-tab-alim="semana">Semana (totais por dia)</button>
          <button class="tab-btn" data-tab-alim="compras">Lista de compras (total da semana)</button>
        </div>

        <div id="alim-dia">
          <div id="alimDiaInfo" class="help-text" style="margin-bottom: 6px;"></div>
          <div id="alimDiaContainer"></div>
        </div>

        <div id="alim-semana" class="hidden">
          <div id="alimSemanaContainer"></div>
        </div>

        <div id="alim-compras" class="hidden">
          <div id="shoppingContainer"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const STORAGE_KEY = "guerra_fit_logs_v3";
    const SHOPPING_KEY = "guerra_fit_shopping_v3";

    let baseExercises = [];
    let dailyLog = {};
    let nutritionEntries = [];

    function todayISO() {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60000);
      return local.toISOString().slice(0, 10);
    }
    function loadDailyLog() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        dailyLog = raw ? JSON.parse(raw) : {};
      } catch { dailyLog = {}; }
    }
    function saveDailyLog() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dailyLog));
    }
    function setStatus(msg) {
      const el = document.getElementById("statusArea");
      if (el) el.textContent = msg;
    }
    function cleanText(str) {
      return (str || "").replace(/\uFFFD/g, "-");
    }

    /* -------- CSV TREINO -------- */
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length < 2) return [];
      let delimiter = ";";
      if (lines[0].includes(",") && !lines[0].includes(";")) delimiter = ",";
      const headers = lines[0].split(delimiter).map(h => h.trim());
      function getVal(cells, name) {
        const idx = headers.indexOf(name);
        return idx === -1 ? "" : cleanText((cells[idx] || "").trim());
      }
      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split(delimiter);
        const row = {
          dia:        getVal(cells, "Dia"),
          grupo:      getVal(cells, "Grupo"),
          exercicio:  getVal(cells, "Exerc√≠cio"),
          tipo:       getVal(cells, "Tipo"),
          series:     getVal(cells, "S√©ries"),
          repsTempo:  getVal(cells, "Reps/Tempo"),
          rpeZona:    getVal(cells, "RPE/Zona"),
          aquecimento:getVal(cells, "Aquecimento?"),
          midia:      getVal(cells, "Link v√≠deo")
        };
        if (Object.values(row).every(v => !v)) continue;
        out.push(row);
      }
      return out;
    }

    function rebuildDiaOptions() {
      const sel = document.getElementById("diaSelect");
      if (!sel) return;
      const dias = Array.from(new Set(baseExercises.map(e => (e.dia || "").trim()))).filter(Boolean);
      const ordem = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
      dias.sort((a,b) => {
        const ia = ordem.indexOf(a), ib = ordem.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = ""; opt0.textContent = "Selecione o dia";
      sel.appendChild(opt0);
      dias.forEach(d => {
        const o = document.createElement("option");
        o.value = d; o.textContent = d;
        sel.appendChild(o);
      });
      const mapa = {0:"Domingo",1:"Segunda",2:"Ter√ßa",3:"Quarta",4:"Quinta",5:"Sexta",6:"S√°bado"};
      const hoje = mapa[new Date().getDay()];
      if (dias.includes(hoje)) sel.value = hoje;
    }

    function getDiaSelecionado() {
      const sel = document.getElementById("diaSelect");
      return sel && sel.value ? sel.value : "";
    }
    function getDataSelecionada() {
      const inp = document.getElementById("dataInput");
      return inp && inp.value ? inp.value : todayISO();
    }

    function keyFor(exId, dateStr) {
      return exId + "::" + dateStr;
    }
    function getLog(exId, dateStr) {
      const key = keyFor(exId, dateStr);
      if (!dailyLog[key]) {
        dailyLog[key] = {
          peso: "", rpePercebido: "",
          carga1: "", carga2: "", carga3: "", carga4: "",
          tempoCardioMin: "", distCardioKm: "", cardioTipo: "",
          obs: "", concluido: false
        };
      }
      return dailyLog[key];
    }
    function updateLogField(exId, field, value) {
      const date = getDataSelecionada();
      const log = getLog(exId, date);
      log[field] = value;
      dailyLog[keyFor(exId, date)] = log;
      saveDailyLog();
      updateCardioSummary();
    }
    function updateLogCheckbox(exId, field, checked) {
      updateLogField(exId, field, !!checked);
    }

    /* -------- RENDER TREINO -------- */
    function renderDia() {
      const container = document.getElementById("diaContainer");
      const info = document.getElementById("diaInfo");
      if (!container || !info) return;
      container.innerHTML = "";

      if (!baseExercises.length) {
        info.textContent = "Carregue um arquivo de treinos (.csv) para come√ßar.";
        return;
      }

      const diaSel = getDiaSelecionado();
      const dataSel = getDataSelecionada();
      if (!diaSel) {
        info.textContent = "Selecione o dia do treino.";
        return;
      }

      info.textContent = "Treino de " + diaSel + " em " + dataSel + ".";
      const listaDia = baseExercises.filter(e => (e.dia || "").trim() === diaSel);
      if (!listaDia.length) {
        container.innerHTML = "<div class='help-text'>Nenhum exerc√≠cio configurado para este dia.</div>";
        return;
      }

      listaDia.forEach((ex, idx) => {
        const exId = "ex_" + idx + "_" + diaSel;
        const log = getLog(exId, dataSel);

        const grupoLower = (ex.grupo || "").toLowerCase();
        const tipoLower  = (ex.tipo  || "").toLowerCase();

        const isCorrida =
          grupoLower.includes("corrida") ||
          tipoLower.includes("corrida");

        const isWarmup =
          grupoLower.includes("aquecimento");

        const isCardioBase =
          isCorrida ||
          isWarmup ||
          grupoLower.includes("cardio") ||
          grupoLower.includes("recupera√ß√£o") ||
          grupoLower.includes("recuperacao") ||
          grupoLower.includes("esteira") ||
          grupoLower.includes("el√≠ptico") ||
          grupoLower.includes("eliptico") ||
          grupoLower.includes("bike") ||
          tipoLower.includes("cardio");

        const isCardio = isCardioBase;
        const isForca = !isCardio;

        const card = document.createElement("div");
        card.className = "exercise-card";
        if (isWarmup) card.classList.add("card-warmup");
        else if (isCardio) card.classList.add("card-cardio");
        if (isForca) card.classList.add("card-strength");

        const header = document.createElement("div");
        header.className = "exercise-header";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.className = "exercise-title";

        let icon = "üèãÔ∏è ";
        if (isCardio) icon = "üèÉ ";
        if (isWarmup) icon = "üî• ";

        if (isWarmup) title.classList.add("warmup-title");
        else if (isCardio) title.classList.add("cardio-title");
        else if (isForca) title.classList.add("strength-title");

        title.textContent = icon + (ex.exercicio || "");

        const sub = document.createElement("div");
        sub.className = "exercise-sub";
        sub.textContent = (ex.grupo || "") + (ex.tipo ? " ‚Ä¢ " + ex.tipo : "");

        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        right.className = "exercise-header-right";
        const pill = document.createElement("div");
        pill.className = "pill";
        if (isWarmup) pill.classList.add("badge-warmup");
        else if (isCardio) pill.classList.add("badge-cardio");
        else if (isForca) pill.classList.add("badge-strength");
        pill.textContent = cleanText(ex.repsTempo || "") +
          (ex.rpeZona ? " ¬∑ " + cleanText(ex.rpeZona) : "");
        right.appendChild(pill);

        header.appendChild(left);
        header.appendChild(right);
        card.appendChild(header);

        if (isCorrida) {
          const meta = document.createElement("div");
          meta.className = "run-meta";
          const tempo = cleanText(ex.repsTempo || "");
          const zona  = cleanText(ex.rpeZona || "");
          meta.innerHTML = `
            <div class="run-meta-title">
              <span>üèÉ</span><span>Meta da corrida</span>
            </div>
            <div class="run-meta-grid">
              <div class="run-meta-item">
                <b>Tempo alvo</b>
                <span>${tempo || "‚Äî"}</span>
              </div>
              <div class="run-meta-item">
                <b>Dist√¢ncia / descri√ß√£o</b>
                <span>${tempo || "Conforme plano"}</span>
              </div>
              <div class="run-meta-item">
                <b>Intensidade</b>
                <span>${zona || "‚Äî"}</span>
              </div>
            </div>`;
          card.appendChild(meta);
        }

        const fields = document.createElement("div");
        fields.className = "exercise-fields";

        const fbPeso = document.createElement("div");
        fbPeso.className = "field-block";
        fbPeso.innerHTML = `
          <label>Peso corporal (kg)</label>
          <input type="number" step="0.1" value="${log.peso || ""}" />`;
        fbPeso.querySelector("input").addEventListener("change", e =>
          updateLogField(exId, "peso", e.target.value)
        );
        fields.appendChild(fbPeso);

        const fbRPE = document.createElement("div");
        fbRPE.className = "field-block";
        fbRPE.innerHTML = `
          <label>RPE percebido (1‚Äì10)</label>
          <input type="number" step="0.5" min="1" max="10" value="${log.rpePercebido || ""}" />`;
        fbRPE.querySelector("input").addEventListener("change", e =>
          updateLogField(exId, "rpePercebido", e.target.value)
        );
        fields.appendChild(fbRPE);

        if (!isCardio || (isCardio && !isCorrida)) {
          const fbCarga = document.createElement("div");
          fbCarga.className = "field-block";
          fbCarga.innerHTML = `<label>Cargas (S1‚ÄìS4) ‚Äì kg</label>`;
          const wrap = document.createElement("div");
          wrap.style.display = "grid";
          wrap.style.gridTemplateColumns = "repeat(4, minmax(0, 1fr))";
          wrap.style.gap = "4px";
          ["carga1","carga2","carga3","carga4"].forEach((field,i) => {
            const inp = document.createElement("input");
            inp.type = "number";
            inp.step = "0.5";
            inp.placeholder = "S" + (i+1);
            inp.value = log[field] || "";
            inp.addEventListener("change", e => updateLogField(exId, field, e.target.value));
            wrap.appendChild(inp);
          });
          fbCarga.appendChild(wrap);
          fields.appendChild(fbCarga);
        }

        if (isCorrida) {
          const fbTipo = document.createElement("div");
          fbTipo.className = "field-block";
          fbTipo.innerHTML = `
            <label>Tipo de corrida</label>
            <select>
              <option value="">Selecione</option>
              <option value="Esteira">Esteira</option>
              <option value="Rua">Rua / Outdoor</option>
            </select>`;
          fbTipo.querySelector("select").value = log.cardioTipo || "";
          fbTipo.querySelector("select").addEventListener("change", e =>
            updateLogField(exId, "cardioTipo", e.target.value)
          );
          fields.appendChild(fbTipo);

          const fbTempo = document.createElement("div");
          fbTempo.className = "field-block";
          fbTempo.innerHTML = `
            <label>Tempo realizado (min)</label>
            <input type="number" step="1" value="${log.tempoCardioMin || ""}" />`;
          fbTempo.querySelector("input").addEventListener("change", e =>
            updateLogField(exId, "tempoCardioMin", e.target.value)
          );
          fields.appendChild(fbTempo);

          const fbDist = document.createElement("div");
          fbDist.className = "field-block";
          fbDist.innerHTML = `
            <label>Dist√¢ncia realizada (km)</label>
            <input type="number" step="0.1" value="${log.distCardioKm || ""}" />`;
          fbDist.querySelector("input").addEventListener("change", e =>
            updateLogField(exId, "distCardioKm", e.target.value)
          );
          fields.appendChild(fbDist);
        }

        const fbObs = document.createElement("div");
        fbObs.className = "field-block";
        fbObs.innerHTML = `<label>Observa√ß√µes</label><textarea>${log.obs || ""}</textarea>`;
        fbObs.querySelector("textarea").addEventListener("change", e =>
          updateLogField(exId, "obs", e.target.value)
        );
        fields.appendChild(fbObs);

        card.appendChild(fields);

        const bottom = document.createElement("div");
        bottom.className = "bottom-row";
        const lblChk = document.createElement("label");
        lblChk.innerHTML = `<input type="checkbox" ${log.concluido ? "checked" : ""}/> Exerc√≠cio conclu√≠do`;
        lblChk.querySelector("input").addEventListener("change", e =>
          updateLogCheckbox(exId, "concluido", e.target.checked)
        );
        bottom.appendChild(lblChk);

        if (ex.midia) {
          const btn = document.createElement("button");
          btn.textContent = "V√≠deo / imagem";
          btn.addEventListener("click", () => window.open(ex.midia, "_blank"));
          bottom.appendChild(btn);
        }

        card.appendChild(bottom);
        container.appendChild(card);
      });

      updateCardioSummary();
    }

    /* -------- CARDIO RESUMO -------- */
    function updateCardioSummary() {
      const diaSel = getDiaSelecionado();
      const dataSel = getDataSelecionada();
      const diaDiv = document.getElementById("cardioDiaResumo");
      const semDiv = document.getElementById("cardioSemanaResumo");
      if (!diaDiv || !semDiv) return;

      if (!baseExercises.length || !diaSel) {
        diaDiv.textContent = "Nenhum treino selecionado.";
        semDiv.textContent = "Nenhum dado dispon√≠vel.";
        return;
      }

      let totalMinDia = 0, totalKmDia = 0;
      Object.keys(dailyLog).forEach(key => {
        const [exId, data] = key.split("::");
        if (data !== dataSel) return;
        const log = dailyLog[key];
        const match = exId.match(/^ex_(\d+)_/);
        if (!match) return;
        const idx = parseInt(match[1],10);
        const exList = baseExercises.filter(e => (e.dia || "").trim() === diaSel);
        const ex = exList[idx];
        if (!ex) return;
        const grupoLower = (ex.grupo || "").toLowerCase();
        const tipoLower  = (ex.tipo  || "").toLowerCase();
        const isCardio =
          grupoLower.includes("corrida") ||
          grupoLower.includes("cardio") ||
          grupoLower.includes("aquecimento") ||
          grupoLower.includes("recupera√ß√£o") ||
          grupoLower.includes("recuperacao") ||
          grupoLower.includes("esteira") ||
          grupoLower.includes("el√≠ptico") ||
          grupoLower.includes("eliptico") ||
          grupoLower.includes("bike") ||
          tipoLower.includes("cardio") ||
          tipoLower.includes("corrida");
        if (!isCardio) return;
        const min = parseFloat(log.tempoCardioMin || "0") || 0;
        const km  = parseFloat(log.distCardioKm   || "0") || 0;
        totalMinDia += min; totalKmDia += km;
      });

      if (totalMinDia > 0 || totalKmDia > 0) {
        let pace = "";
        if (totalMinDia > 0 && totalKmDia > 0) {
          pace = " ¬∑ " + (totalMinDia/totalKmDia).toFixed(1) + " min/km";
        }
        diaDiv.textContent = totalMinDia.toFixed(0) + " min ¬∑ " + totalKmDia.toFixed(2) + " km" + pace;
      } else {
        diaDiv.textContent = "Nenhum registro de cardio para esta data.";
      }

      let totalMinSem = 0, totalKmSem = 0;
      const baseDate = new Date(dataSel);
      Object.keys(dailyLog).forEach(key => {
        const [exId, data] = key.split("::");
        const d = new Date(data);
        const diff = (baseDate - d)/(1000*60*60*24);
        if (diff < 0 || diff > 7) return;
        const log = dailyLog[key];
        const match = exId.match(/^ex_(\d+)_([^:]+)$/);
        if (!match) return;
        const idx = parseInt(match[1],10);
        const diaEx = match[2];
        const exList = baseExercises.filter(e => (e.dia || "").trim() === diaEx);
        const ex = exList[idx];
        if (!ex) return;
        const grupoLower = (ex.grupo || "").toLowerCase();
        const tipoLower  = (ex.tipo  || "").toLowerCase();
        const isCardio =
          grupoLower.includes("corrida") ||
          grupoLower.includes("cardio") ||
          grupoLower.includes("aquecimento") ||
          grupoLower.includes("recupera√ß√£o") ||
          grupoLower.includes("recuperacao") ||
          grupoLower.includes("esteira") ||
          grupoLower.includes("el√≠ptico") ||
          grupoLower.includes("eliptico") ||
          grupoLower.includes("bike") ||
          tipoLower.includes("cardio") ||
          tipoLower.includes("corrida");
        if (!isCardio) return;
        const min = parseFloat(log.tempoCardioMin || "0") || 0;
        const km  = parseFloat(log.distCardioKm   || "0") || 0;
        totalMinSem += min; totalKmSem += km;
      });

      if (totalMinSem > 0 || totalKmSem > 0) {
        let pace = "";
        if (totalMinSem > 0 && totalKmSem > 0) {
          pace = " ¬∑ " + (totalMinSem/totalKmSem).toFixed(1) + " min/km";
        }
        semDiv.textContent = totalMinSem.toFixed(0) + " min ¬∑ " + totalKmSem.toFixed(2) + " km" + pace;
      } else {
        semDiv.textContent = "Nenhum registro de cardio nos √∫ltimos 7 dias.";
      }
    }

    /* -------- EXPORT / RESET -------- */
    function exportJson() {
      const data = JSON.stringify(dailyLog, null, 2);
      const blob = new Blob([data], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "guerra_fit_logs.json";
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
      setStatus("Exportado guerra_fit_logs.json.");
    }
    function resetDia() {
      const dataSel = getDataSelecionada();
      const novo = {};
      Object.keys(dailyLog).forEach(key => {
        const [,data] = key.split("::");
        if (data === dataSel) return;
        novo[key] = dailyLog[key];
      });
      dailyLog = novo;
      saveDailyLog();
      renderDia();
      setStatus("Dados de " + dataSel + " limpos.");
    }

    /* -------- CSV ALIMENTA√á√ÉO -------- */
    function parseAlimCSV(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length < 2) return [];
      let delimiter = ";";
      if (lines[0].includes(",") && !lines[0].includes(";")) delimiter = ",";
      const headers = lines[0].split(delimiter).map(h => h.trim());
      function getVal(cells, name) {
        const idx = headers.indexOf(name);
        return idx === -1 ? "" : (cells[idx] || "").trim();
      }
      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split(delimiter);
        const row = {
          dia:       getVal(cells, "Dia"),
          refeicao:  getVal(cells, "Refei√ß√£o"),
          item:      getVal(cells, "Item"),
          quantidade:getVal(cells, "Quantidade"),
          unidade:   getVal(cells, "Unidade"),
          grupo:     getVal(cells, "Grupo")
        };
        if (!row.dia && !row.item) continue;
        out.push(row);
      }
      return out;
    }

    function diaFromDate(iso) {
      const d = new Date(iso);
      const mapa = {0:"Domingo",1:"Segunda",2:"Ter√ßa",3:"Quarta",4:"Quinta",5:"Sexta",6:"S√°bado"};
      return mapa[d.getDay()];
    }

    /* -------- ALIMENTA√á√ÉO: DIA -------- */
    function renderCardapioDia() {
      const info = document.getElementById("alimDiaInfo");
      const cont = document.getElementById("alimDiaContainer");
      if (!info || !cont) return;
      const dataSel = getDataSelecionada();
      const diaSel = getDiaSelecionado() || diaFromDate(dataSel);

      if (!nutritionEntries.length) {
        info.textContent = "Carregue um arquivo de alimenta√ß√£o (.csv) para ver o card√°pio do dia.";
        cont.innerHTML = "";
        return;
      }

      info.textContent = "Card√°pio de " + diaSel + " (" + dataSel + ").";
      const diaItens = nutritionEntries.filter(n => (n.dia || "").trim() === diaSel);
      cont.innerHTML = "";

      if (!diaItens.length) {
        cont.innerHTML = "<div class='help-text'>Nenhum item de alimenta√ß√£o cadastrado para este dia.</div>";
        return;
      }

      const byMeal = {};
      diaItens.forEach(n => {
        const ref = n.refeicao || "Refei√ß√£o";
        if (!byMeal[ref]) byMeal[ref] = [];
        byMeal[ref].push(n);
      });

      Object.keys(byMeal).forEach(ref => {
        const div = document.createElement("div");
        div.className = "meal-block";

        const t = document.createElement("div");
        t.className = "meal-title";
        t.textContent = ref;
        div.appendChild(t);

        const ul = document.createElement("ul");
        ul.style.margin = "0";
        ul.style.paddingLeft = "18px";
        ul.style.fontSize = "13px";

        byMeal[ref].forEach(n => {
          const li = document.createElement("li");
          const qtd = n.quantidade ? n.quantidade : "";
          const un  = n.unidade ? " " + n.unidade : "";
          li.textContent = (qtd ? qtd + un + " " : "") + n.item;
          ul.appendChild(li);
        });

        div.appendChild(ul);
        cont.appendChild(div);
      });
    }

    /* -------- ALIMENTA√á√ÉO: SEMANA (TOTAIS POR DIA) -------- */
    function renderCardapioSemana() {
      const cont = document.getElementById("alimSemanaContainer");
      if (!cont) return;

      if (!nutritionEntries.length) {
        cont.innerHTML = "<div class='help-text'>Carregue um arquivo de alimenta√ß√£o (.csv) para ver o resumo da semana.</div>";
        return;
      }

      // Agrupa por dia e soma quantidades por item+unidade
      const byDay = {};
      nutritionEntries.forEach(n => {
        if (!n.dia || !n.item) return;
        const dia = (n.dia || "").trim();
        const item = n.item || "";
        const unidade = n.unidade || "";
        const key = item + "||" + unidade;
        let qtd = parseFloat((n.quantidade || "0").replace(",", ".")) || 0;

        if (!byDay[dia]) byDay[dia] = {};
        if (!byDay[dia][key]) byDay[dia][key] = {item, unidade, quantidade:0};
        byDay[dia][key].quantidade += qtd;
      });

      const ordem = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
      const diasOrdenados = Object.keys(byDay).sort((a,b) => {
        const ia = ordem.indexOf(a), ib = ordem.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });

      let html = "<div class='help-text' style='margin-bottom:6px;'>Totais de cada alimento por dia (soma de todas as refei√ß√µes).</div>";
      diasOrdenados.forEach(dia => {
        html += `<div class="meal-block">`;
        html += `<div class="meal-title">${dia}</div>`;
        html += `<ul style="margin:0; padding-left:18px; font-size:13px;">`;
        const itens = byDay[dia];
        Object.keys(itens).forEach(key => {
          const it = itens[key];
          const qtdTxt = it.quantidade ? it.quantidade.toFixed(1).replace(".0","") : "";
          const un = it.unidade ? " " + it.unidade : "";
          html += `<li>${qtdTxt}${un} ${it.item}</li>`;
        });
        html += `</ul></div>`;
      });

      cont.innerHTML = html;
    }

    /* -------- ALIMENTA√á√ÉO: LISTA DE COMPRAS (SEMANA) -------- */
    function renderShopping() {
      const cont = document.getElementById("shoppingContainer");
      if (!cont) return;
      cont.innerHTML = "";

      let state = {};
      try {
        const raw = localStorage.getItem(SHOPPING_KEY);
        state = raw ? JSON.parse(raw) : {};
      } catch { state = {}; }

      if (!nutritionEntries.length) {
        cont.innerHTML = "<div class='help-text'>Carregue um arquivo de alimenta√ß√£o (.csv) para gerar a lista de compras.</div>";
        return;
      }

      const agg = {};
      nutritionEntries.forEach(n => {
        if (!n.item) return;
        const unidade = n.unidade || "";
        const key = (n.item + "|" + unidade).toLowerCase();
        const grupo = n.grupo || "Outros";
        let qtd = parseFloat((n.quantidade || "0").replace(",", ".")) || 0;
        if (!agg[key]) {
          agg[key] = {item:n.item, unidade:unidade, grupo:grupo, quantidade:0};
        }
        agg[key].quantidade += qtd;
      });

      const byCat = {};
      Object.keys(agg).forEach(key => {
        const it = agg[key];
        if (!byCat[it.grupo]) byCat[it.grupo] = [];
        byCat[it.grupo].push({key, ...it});
      });

      Object.keys(byCat).forEach(cat => {
        const catDiv = document.createElement("div");
        const title = document.createElement("div");
        title.className = "shopping-category-title";
        title.textContent = cat;
        catDiv.appendChild(title);

        byCat[cat].forEach(it => {
          const row = document.createElement("div");
          row.className = "shopping-item";
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.checked = !!state[it.key];
          chk.addEventListener("change", e => {
            state[it.key] = e.target.checked;
            localStorage.setItem(SHOPPING_KEY, JSON.stringify(state));
          });

          const span = document.createElement("span");
          const qtdTxt = it.quantidade ? it.quantidade.toFixed(1).replace(".0","") : "";
          const un = it.unidade ? " " + it.unidade : "";
          span.textContent = (qtdTxt ? qtdTxt + un + " " : "") + it.item;

          row.appendChild(chk);
          row.appendChild(span);
          catDiv.appendChild(row);
        });

        cont.appendChild(catDiv);
      });
    }

    /* -------- TABS / INIT -------- */
    function initMainTabs() {
      const buttons = document.querySelectorAll(".top-tab-btn");
      const viewTreino = document.getElementById("view-treino");
      const viewAlim = document.getElementById("view-alimentacao");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          if (btn.dataset.main === "treino") {
            viewTreino.classList.remove("hidden");
            viewAlim.classList.add("hidden");
          } else {
            viewTreino.classList.add("hidden");
            viewAlim.classList.remove("hidden");
          }
        });
      });
    }

    function initTreinoTabs() {
      const btns = document.querySelectorAll("[data-tab-treino]");
      const tabDia = document.getElementById("tab-dia");
      const tabCardio = document.getElementById("tab-cardio");
      btns.forEach(btn => {
        btn.addEventListener("click", () => {
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tabTreino;
          if (tab === "dia") {
            tabDia.classList.remove("hidden");
            tabCardio.classList.add("hidden");
          } else {
            tabDia.classList.add("hidden");
            tabCardio.classList.remove("hidden");
          }
        });
      });
    }

    function initAlimTabs() {
      const btns = document.querySelectorAll("[data-tab-alim]");
      const d = document.getElementById("alim-dia");
      const s = document.getElementById("alim-semana");
      const c = document.getElementById("alim-compras");
      btns.forEach(btn => {
        btn.addEventListener("click", () => {
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tabAlim;
          d.classList.add("hidden");
          s.classList.add("hidden");
          c.classList.add("hidden");
          if (tab === "dia")    d.classList.remove("hidden");
          if (tab === "semana") s.classList.remove("hidden");
          if (tab === "compras")c.classList.remove("hidden");
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadDailyLog();

      const dataInput = document.getElementById("dataInput");
      if (dataInput && !dataInput.value) dataInput.value = todayISO();

      initMainTabs();
      initTreinoTabs();
      initAlimTabs();

      renderCardapioDia();
      renderCardapioSemana();
      renderShopping();

      const csvInput = document.getElementById("csvInput");
      if (csvInput) {
        csvInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              baseExercises = parseCSV(ev.target.result);
              setStatus("Arquivo de treinos carregado com " + baseExercises.length + " linhas.");
              rebuildDiaOptions();
              renderDia();
            } catch (err) {
              console.error(err);
              setStatus("Erro ao ler arquivo de treinos.");
            }
          };
          reader.readAsText(file, "utf-8");
        });
      }

      const alimCsvInput = document.getElementById("alimCsvInput");
      if (alimCsvInput) {
        alimCsvInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              nutritionEntries = parseAlimCSV(ev.target.result);
              renderCardapioDia();
              renderCardapioSemana();
              renderShopping();
            } catch (err) {
              console.error(err);
            }
          };
          reader.readAsText(file, "utf-8");
        });
      }

      const diaSelect = document.getElementById("diaSelect");
      if (diaSelect) {
        diaSelect.addEventListener("change", () => {
          renderDia();
          renderCardapioDia();
        });
      }

      if (dataInput) {
        dataInput.addEventListener("change", () => {
          renderDia();
          renderCardapioDia();
        });
      }

      const btnExport = document.getElementById("btnExport");
      if (btnExport) btnExport.addEventListener("click", exportJson);
      const btnReset = document.getElementById("btnReset");
      if (btnReset) btnReset.addEventListener("click", resetDia);
    });
  </script>
</body>
</html>
