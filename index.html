<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Guerra Fit ‚Äì Treinos, Corrida e Alimenta√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tema Apple Fitness-like: cardio verde, for√ßa vermelha -->
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #000000;
      color: #f9fafb;
    }
    header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #111827, #020617 65%);
    }
    header h1 {
      margin: 0 0 4px 0;
      font-size: 20px;
      font-weight: 700;
    }
    header small {
      color: #9ca3af;
      font-size: 12px;
    }
    main {
      padding: 10px;
      max-width: 960px;
      margin: 0 auto 40px auto;
    }

    .card {
      background: #05050a;
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px;
      margin-bottom: 14px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .col-6 {
      flex: 1 1 260px;
      min-width: 0;
    }

    label {
      font-size: 12px;
      margin-bottom: 3px;
      display: block;
    }
    input,
    select,
    textarea {
      width: 100%;
      background: #020617;
      border-radius: 12px;
      border: 1px solid #374151;
      padding: 8px 10px;
      color: #f9fafb;
      font-size: 13px;
    }
    input[type="file"] {
      padding: 6px 10px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    button.primary {
      background: #0a84ff; /* azul Apple */
      border-color: #0a84ff;
    }
    .help-text {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Tabs principais (Treinos / Alimenta√ß√£o) */
    .top-tabs {
      display: flex;
      gap: 8px;
    }
    .top-tab-btn {
      flex: 1;
      padding: 10px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
      font-size: 14px;
      font-weight: 500;
    }
    .top-tab-btn.active {
      background: #34c759;  /* verde Apple Fitness */
      border-color: #34c759;
      color: #000000;
    }

    /* Tabs internas */
    .tab-strip {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
      font-size: 13px;
    }
    .tab-btn.active {
      background: #0a84ff;
      border-color: #0a84ff;
      color: #ffffff;
    }

    .hidden { display: none; }

    /* Exerc√≠cios */
    .exercise-card {
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px;
      margin-bottom: 10px;
      background: #020617;
    }

    /* For√ßa / muscula√ß√£o ‚Äì vermelho */
    .card-strength {
      border-color: #ff3b30;
      box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.18);
    }
    .strength-title { color: #ff453a; }
    .badge-strength {
      border-color: #ff3b30;
      color: #ff9f9a;
    }

    /* Cardio / corrida ‚Äì verde */
    .card-cardio {
      background: radial-gradient(circle at top left, #022c22, #020617 70%);
      border-color: #34c759;
      box-shadow: 0 0 0 1px rgba(52, 199, 89, 0.22);
    }
    .cardio-title { color: #34c759; }
    .badge-cardio {
      border-color: #34c759;
      color: #bbf7d0;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .exercise-title {
      font-size: 14px;
      font-weight: 600;
    }
    .exercise-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    .exercise-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .exercise-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }
    @media (max-width: 640px) {
      .exercise-fields { grid-template-columns: 1fr; }
    }
    .field-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .bottom-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 11px;
    }

    /* Meta corrida */
    .run-meta {
      border-radius: 12px;
      border: 1px solid #34c759;
      background: rgba(22, 163, 74, 0.12);
      padding: 8px;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .run-meta-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #a7f3d0;
    }
    .run-meta-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }
    @media (max-width: 640px) {
      .run-meta-grid { grid-template-columns: 1fr; }
    }
    .run-meta-item {
      font-size: 11px;
      color: #d1fae5;
    }
    .run-meta-item b {
      display: block;
      font-size: 11px;
      color: #86efac;
    }

    /* Resumo cardio */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 640px) {
      .summary-grid { grid-template-columns: 1fr; }
    }
    .summary-box {
      border-radius: 12px;
      border: 1px solid #111827;
      padding: 10px;
      background: #020617;
    }
    .summary-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* Alimenta√ß√£o */
    .meal-block {
      border-radius: 12px;
      border: 1px solid #111827;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #020617;
      font-size: 13px;
    }
    .meal-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .shopping-category-title {
      font-weight: 600;
      margin: 8px 0 4px 0;
      font-size: 13px;
    }
    .shopping-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin-bottom: 3px;
    }

    #statusArea {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <header>
    <h1>Guerra Fit</h1>
    <small>Treinos, corrida e alimenta√ß√£o ‚Äî semana iniciando na ter√ßa.</small>
  </header>

  <main>
    <!-- Tabs principais -->
    <div class="card">
      <div class="top-tabs">
        <button class="top-tab-btn active" data-main="treino">Treinos</button>
        <button class="top-tab-btn" data-main="alimentacao">Alimenta√ß√£o</button>
      </div>
    </div>

    <!-- VIEW TREINO -->
    <div id="view-treino">
      <div class="card">
        <div class="row">
          <div class="col-6">
            <label>Arquivo de treinos (.csv)</label>
            <input type="file" id="csvInput" accept=".csv" />
          </div>
          <div class="col-6">
            <label>Dia do treino</label>
            <select id="diaSelect"></select>
          </div>
        </div>

        <div class="row" style="margin-top: 8px;">
          <div class="col-6">
            <label>Data</label>
            <input type="date" id="dataInput" />
          </div>
          <div class="col-6">
            <div class="help-text" style="padding-top: 9px;">
              Todos os dados (peso, cargas, corrida, RPE) s√£o salvos automaticamente no navegador.
            </div>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col-6">
            <button id="btnExport" class="primary">Exportar dados (.json)</button>
          </div>
          <div class="col-6">
            <button id="btnReset">Limpar dados deste dia</button>
          </div>
        </div>

        <div id="statusArea">Nenhum treino carregado ainda.</div>
      </div>

      <div class="card">
        <div class="tab-strip">
          <button class="tab-btn active" data-tab-treino="dia">Treino do dia</button>
          <button class="tab-btn" data-tab-treino="cardio">Cardio ‚Äî dia / semana</button>
        </div>

        <div id="tab-dia">
          <div id="diaInfo" class="help-text" style="margin-bottom: 6px;"></div>
          <div id="diaContainer"></div>
        </div>

        <div id="tab-cardio" class="hidden">
          <div class="summary-grid">
            <div class="summary-box">
              <div class="summary-title">Cardio do dia</div>
              <div id="cardioDiaResumo" class="help-text"></div>
            </div>
            <div class="summary-box">
              <div class="summary-title">Cardio √∫ltimos 7 dias</div>
              <div id="cardioSemanaResumo" class="help-text"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW ALIMENTA√á√ÉO -->
    <div id="view-alimentacao" class="hidden">
      <div class="card">
        <div class="tab-strip">
          <button class="tab-btn active" data-tab-alim="dia">Card√°pio do dia</button>
          <button class="tab-btn" data-tab-alim="semana">Semana</button>
          <button class="tab-btn" data-tab-alim="compras">Lista de compras</button>
        </div>

        <div id="alim-dia">
          <div id="alimDiaInfo" class="help-text" style="margin-bottom: 6px;"></div>
          <div id="alimDiaContainer"></div>
        </div>

        <div id="alim-semana" class="hidden">
          <div id="alimSemanaContainer"></div>
        </div>

        <div id="alim-compras" class="hidden">
          <div id="shoppingContainer"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const STORAGE_KEY = "guerra_fit_logs_v3";
    const SHOPPING_KEY = "guerra_fit_shopping_v2";

    let baseExercises = [];
    let dailyLog = {};

    function todayISO() {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60000);
      return local.toISOString().slice(0, 10);
    }
    function loadDailyLog() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        dailyLog = raw ? JSON.parse(raw) : {};
      } catch { dailyLog = {}; }
    }
    function saveDailyLog() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dailyLog));
    }
    function setStatus(msg) {
      const el = document.getElementById("statusArea");
      if (el) el.textContent = msg;
    }

    /* ---- CSV ---- */
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length < 2) return [];
      let delimiter = ";";
      if (lines[0].includes(",") && !lines[0].includes(";")) delimiter = ",";
      const headers = lines[0].split(delimiter).map(h => h.trim());
      function getVal(cells, name) {
        const idx = headers.indexOf(name);
        return idx === -1 ? "" : (cells[idx] || "").trim();
      }
      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split(delimiter);
        const row = {
          dia:        getVal(cells, "Dia"),
          grupo:      getVal(cells, "Grupo"),
          exercicio:  getVal(cells, "Exerc√≠cio"),
          tipo:       getVal(cells, "Tipo"),
          series:     getVal(cells, "S√©ries"),
          repsTempo:  getVal(cells, "Reps/Tempo"),
          rpeZona:    getVal(cells, "RPE/Zona"),
          aquecimento:getVal(cells, "Aquecimento?"),
          midia:      getVal(cells, "Link v√≠deo")
        };
        if (Object.values(row).every(v => !v)) continue;
        out.push(row);
      }
      return out;
    }

    function rebuildDiaOptions() {
      const sel = document.getElementById("diaSelect");
      if (!sel) return;
      const dias = Array.from(new Set(baseExercises.map(e => (e.dia || "").trim()))).filter(Boolean);
      const ordem = ["Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo","Segunda"];
      dias.sort((a,b) => {
        const ia = ordem.indexOf(a), ib = ordem.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = ""; opt0.textContent = "Selecione o dia";
      sel.appendChild(opt0);
      dias.forEach(d => {
        const o = document.createElement("option");
        o.value = d; o.textContent = d;
        sel.appendChild(o);
      });
      const mapa = {0:"Domingo",1:"Segunda",2:"Ter√ßa",3:"Quarta",4:"Quinta",5:"Sexta",6:"S√°bado"};
      const hoje = mapa[new Date().getDay()];
      if (dias.includes(hoje)) sel.value = hoje;
    }

    /* ---- LOG ---- */
    function getDiaSelecionado() {
      const sel = document.getElementById("diaSelect");
      return sel && sel.value ? sel.value : "";
    }
    function getDataSelecionada() {
      const inp = document.getElementById("dataInput");
      return inp && inp.value ? inp.value : todayISO();
    }
    function keyFor(exId, dateStr) {
      return exId + "::" + dateStr;
    }
    function getLog(exId, dateStr) {
      const key = keyFor(exId, dateStr);
      if (!dailyLog[key]) {
        dailyLog[key] = {
          peso: "", rpePercebido: "",
          carga1: "", carga2: "", carga3: "", carga4: "",
          tempoCardioMin: "", distCardioKm: "", cardioTipo: "",
          obs: "", concluido: false
        };
      }
      return dailyLog[key];
    }
    function updateLogField(exId, field, value) {
      const date = getDataSelecionada();
      const log = getLog(exId, date);
      log[field] = value;
      dailyLog[keyFor(exId, date)] = log;
      saveDailyLog();
      updateCardioSummary();
    }
    function updateLogCheckbox(exId, field, checked) {
      updateLogField(exId, field, !!checked);
    }

    /* ---- RENDER TREINO ---- */
    function renderDia() {
      const container = document.getElementById("diaContainer");
      const info = document.getElementById("diaInfo");
      if (!container || !info) return;
      container.innerHTML = "";

      if (!baseExercises.length) {
        info.textContent = "Carregue um arquivo de treinos (.csv) para come√ßar.";
        return;
      }

      const diaSel = getDiaSelecionado();
      const dataSel = getDataSelecionada();
      if (!diaSel) {
        info.textContent = "Selecione o dia do treino.";
        return;
      }

      info.textContent = "Treino de " + diaSel + " em " + dataSel + ".";
      const listaDia = baseExercises.filter(e => (e.dia || "").trim() === diaSel);
      if (!listaDia.length) {
        container.innerHTML = "<div class='help-text'>Nenhum exerc√≠cio configurado para este dia.</div>";
        return;
      }

      listaDia.forEach((ex, idx) => {
        const exId = "ex_" + idx + "_" + diaSel;
        const log = getLog(exId, dataSel);

        const grupoLower = (ex.grupo || "").toLowerCase();
        const tipoLower  = (ex.tipo  || "").toLowerCase();

        const isCorrida =
          grupoLower.includes("corrida") ||
          tipoLower.includes("corrida");

        const isCardio =
          isCorrida ||
          grupoLower.includes("cardio") ||
          grupoLower.includes("aquecimento") ||
          grupoLower.includes("recupera√ß√£o") ||
          grupoLower.includes("esteira") ||
          grupoLower.includes("el√≠ptico") ||
          grupoLower.includes("eliptico") ||
          grupoLower.includes("bike") ||
          tipoLower.includes("cardio");

        const isForca = !isCardio;

        const card = document.createElement("div");
        card.className = "exercise-card";
        if (isCardio) card.classList.add("card-cardio");
        if (isForca)  card.classList.add("card-strength");

        const header = document.createElement("div");
        header.className = "exercise-header";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.className = "exercise-title";
        if (isCardio) title.classList.add("cardio-title");
        if (isForca)  title.classList.add("strength-title");
        const icon = isCardio ? "üèÉ " : "üèãÔ∏è ";
        title.textContent = icon + (ex.exercicio || "");

        const sub = document.createElement("div");
        sub.className = "exercise-sub";
        sub.textContent = (ex.grupo || "") + (ex.tipo ? " ‚Ä¢ " + ex.tipo : "");

        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        right.className = "exercise-header-right";
        const pill = document.createElement("div");
        pill.className = "pill";
        if (isCardio) pill.classList.add("badge-cardio");
        if (isForca)  pill.classList.add("badge-strength");
        pill.textContent = (ex.repsTempo || "") + (ex.rpeZona ? " ¬∑ " + ex.rpeZona : "");
        right.appendChild(pill);

        header.appendChild(left);
        header.appendChild(right);
        card.appendChild(header);

        if (isCorrida) {
          const meta = document.createElement("div");
          meta.className = "run-meta";
          meta.innerHTML = `
            <div class="run-meta-title">
              <span>üèÉ</span><span>Meta da corrida</span>
            </div>
            <div class="run-meta-grid">
              <div class="run-meta-item">
                <b>Tempo alvo</b>
                <span>${ex.repsTempo || "‚Äî"}</span>
              </div>
              <div class="run-meta-item">
                <b>Dist√¢ncia / descri√ß√£o</b>
                <span>${(ex.repsTempo || "").includes("alvo") ? ex.repsTempo : "Conforme plano"}</span>
              </div>
              <div class="run-meta-item">
                <b>Intensidade</b>
                <span>${ex.rpeZona || "‚Äî"}</span>
              </div>
            </div>`;
          card.appendChild(meta);
        }

        const fields = document.createElement("div");
        fields.className = "exercise-fields";

        const fbPeso = document.createElement("div");
        fbPeso.className = "field-block";
        fbPeso.innerHTML = `
          <label>Peso corporal (kg)</label>
          <input type="number" step="0.1" value="${log.peso || ""}" />`;
        fbPeso.querySelector("input").addEventListener("change", e =>
          updateLogField(exId, "peso", e.target.value)
        );
        fields.appendChild(fbPeso);

        const fbRPE = document.createElement("div");
        fbRPE.className = "field-block";
        fbRPE.innerHTML = `
          <label>RPE percebido (1‚Äì10)</label>
          <input type="number" step="0.5" min="1" max="10" value="${log.rpePercebido || ""}" />`;
        fbRPE.querySelector("input").addEventListener("change", e =>
          updateLogField(exId, "rpePercebido", e.target.value)
        );
        fields.appendChild(fbRPE);

        if (!isCardio || (isCardio && !isCorrida)) {
          const fbCarga = document.createElement("div");
          fbCarga.className = "field-block";
          fbCarga.innerHTML = `<label>Cargas (S1‚ÄìS4) ‚Äì kg</label>`;
          const wrap = document.createElement("div");
          wrap.style.display = "grid";
          wrap.style.gridTemplateColumns = "repeat(4, minmax(0, 1fr))";
          wrap.style.gap = "4px";
          ["carga1","carga2","carga3","carga4"].forEach((field,i) => {
            const inp = document.createElement("input");
            inp.type = "number";
            inp.step = "0.5";
            inp.placeholder = "S" + (i+1);
            inp.value = log[field] || "";
            inp.addEventListener("change", e => updateLogField(exId, field, e.target.value));
            wrap.appendChild(inp);
          });
          fbCarga.appendChild(wrap);
          fields.appendChild(fbCarga);
        }

        if (isCorrida) {
          const fbTipo = document.createElement("div");
          fbTipo.className = "field-block";
          fbTipo.innerHTML = `
            <label>Tipo de corrida</label>
            <select>
              <option value="">Selecione</option>
              <option value="Esteira">Esteira</option>
              <option value="Rua">Rua / Outdoor</option>
            </select>`;
          fbTipo.querySelector("select").value = log.cardioTipo || "";
          fbTipo.querySelector("select").addEventListener("change", e =>
            updateLogField(exId, "cardioTipo", e.target.value)
          );
          fields.appendChild(fbTipo);

          const fbTempo = document.createElement("div");
          fbTempo.className = "field-block";
          fbTempo.innerHTML = `
            <label>Tempo realizado (min)</label>
            <input type="number" step="1" value="${log.tempoCardioMin || ""}" />`;
          fbTempo.querySelector("input").addEventListener("change", e =>
            updateLogField(exId, "tempoCardioMin", e.target.value)
          );
          fields.appendChild(fbTempo);

          const fbDist = document.createElement("div");
          fbDist.className = "field-block";
          fbDist.innerHTML = `
            <label>Dist√¢ncia realizada (km)</label>
            <input type="number" step="0.1" value="${log.distCardioKm || ""}" />`;
          fbDist.querySelector("input").addEventListener("change", e =>
            updateLogField(exId, "distCardioKm", e.target.value)
          );
          fields.appendChild(fbDist);
        }

        const fbObs = document.createElement("div");
        fbObs.className = "field-block";
        fbObs.innerHTML = `<label>Observa√ß√µes</label><textarea>${log.obs || ""}</textarea>`;
        fbObs.querySelector("textarea").addEventListener("change", e =>
          updateLogField(exId, "obs", e.target.value)
        );
        fields.appendChild(fbObs);

        card.appendChild(fields);

        const bottom = document.createElement("div");
        bottom.className = "bottom-row";
        const lblChk = document.createElement("label");
        lblChk.innerHTML = `<input type="checkbox" ${log.concluido ? "checked" : ""}/> Exerc√≠cio conclu√≠do`;
        lblChk.querySelector("input").addEventListener("change", e =>
          updateLogCheckbox(exId, "concluido", e.target.checked)
        );
        bottom.appendChild(lblChk);

        if (ex.midia) {
          const btn = document.createElement("button");
          btn.textContent = "V√≠deo / imagem";
          btn.addEventListener("click", () => window.open(ex.midia, "_blank"));
          bottom.appendChild(btn);
        }

        card.appendChild(bottom);
        container.appendChild(card);
      });

      updateCardioSummary();
    }

    /* ---- CARDIO RESUMO ---- */
    function updateCardioSummary() {
      const diaSel = getDiaSelecionado();
      const dataSel = getDataSelecionada();
      const diaDiv = document.getElementById("cardioDiaResumo");
      const semDiv = document.getElementById("cardioSemanaResumo");
      if (!diaDiv || !semDiv) return;

      if (!baseExercises.length || !diaSel) {
        diaDiv.textContent = "Nenhum treino selecionado.";
        semDiv.textContent = "Nenhum dado dispon√≠vel.";
        return;
      }

      let totalMinDia = 0, totalKmDia = 0;
      Object.keys(dailyLog).forEach(key => {
        const [exId, data] = key.split("::");
        if (data !== dataSel) return;
        const log = dailyLog[key];
        const match = exId.match(/^ex_(\d+)_/);
        if (!match) return;
        const idx = parseInt(match[1],10);
        const exList = baseExercises.filter(e => (e.dia || "").trim() === diaSel);
        const ex = exList[idx];
        if (!ex) return;
        const grupoLower = (ex.grupo || "").toLowerCase();
        const tipoLower  = (ex.tipo  || "").toLowerCase();
        const isCardio =
          grupoLower.includes("corrida") ||
          grupoLower.includes("cardio") ||
          grupoLower.includes("aquecimento") ||
          grupoLower.includes("recupera√ß√£o") ||
          grupoLower.includes("esteira") ||
          grupoLower.includes("el√≠ptico") ||
          grupoLower.includes("eliptico") ||
          grupoLower.includes("bike") ||
          tipoLower.includes("cardio") ||
          tipoLower.includes("corrida");
        if (!isCardio) return;
        const min = parseFloat(log.tempoCardioMin || "0") || 0;
        const km  = parseFloat(log.distCardioKm   || "0") || 0;
        totalMinDia += min; totalKmDia += km;
      });

      if (totalMinDia > 0 || totalKmDia > 0) {
        let pace = "";
        if (totalMinDia > 0 && totalKmDia > 0) {
          pace = " ¬∑ " + (totalMinDia/totalKmDia).toFixed(1) + " min/km";
        }
        diaDiv.textContent = totalMinDia.toFixed(0) + " min ¬∑ " + totalKmDia.toFixed(2) + " km" + pace;
      } else {
        diaDiv.textContent = "Nenhum registro de cardio para esta data.";
      }

      let totalMinSem = 0, totalKmSem = 0;
      const baseDate = new Date(dataSel);
      Object.keys(dailyLog).forEach(key => {
        const [exId, data] = key.split("::");
        const d = new Date(data);
        const diff = (baseDate - d)/(1000*60*60*24);
        if (diff < 0 || diff > 7) return;
        const log = dailyLog[key];
        const match = exId.match(/^ex_(\d+)_([^:]+)$/);
        if (!match) return;
        const idx = parseInt(match[1],10);
        const diaEx = match[2];
        const exList = baseExercises.filter(e => (e.dia || "").trim() === diaEx);
        const ex = exList[idx];
        if (!ex) return;
        const grupoLower = (ex.grupo || "").toLowerCase();
        const tipoLower  = (ex.tipo  || "").toLowerCase();
        const isCardio =
          grupoLower.includes("corrida") ||
          grupoLower.includes("cardio") ||
          grupoLower.includes("aquecimento") ||
          grupoLower.includes("recupera√ß√£o") ||
          grupoLower.includes("esteira") ||
          grupoLower.includes("el√≠ptico") ||
          grupoLower.includes("eliptico") ||
          grupoLower.includes("bike") ||
          tipoLower.includes("cardio") ||
          tipoLower.includes("corrida");
        if (!isCardio) return;
        const min = parseFloat(log.tempoCardioMin || "0") || 0;
        const km  = parseFloat(log.distCardioKm   || "0") || 0;
        totalMinSem += min; totalKmSem += km;
      });

      if (totalMinSem > 0 || totalKmSem > 0) {
        let pace = "";
        if (totalMinSem > 0 && totalKmSem > 0) {
          pace = " ¬∑ " + (totalMinSem/totalKmSem).toFixed(1) + " min/km";
        }
        semDiv.textContent = totalMinSem.toFixed(0) + " min ¬∑ " + totalKmSem.toFixed(2) + " km" + pace;
      } else {
        semDiv.textContent = "Nenhum registro de cardio nos √∫ltimos 7 dias.";
      }
    }

    /* ---- EXPORT / RESET ---- */
    function exportJson() {
      const data = JSON.stringify(dailyLog, null, 2);
      const blob = new Blob([data], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "guerra_fit_logs.json";
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
      setStatus("Exportado guerra_fit_logs.json.");
    }
    function resetDia() {
      const diaSel = getDiaSelecionado();
      const dataSel = getDataSelecionada();
      if (!diaSel) return;
      const novo = {};
      Object.keys(dailyLog).forEach(key => {
        const [,data] = key.split("::");
        if (data === dataSel) return;
        novo[key] = dailyLog[key];
      });
      dailyLog = novo;
      saveDailyLog();
      renderDia();
      setStatus("Dados de " + dataSel + " limpos.");
    }

    /* ---- ALIMENTA√á√ÉO ---- */
    const shoppingItems = [
      { id:"frango",    label:"Peito de frango (2‚Äì3kg)",             category:"Prote√≠nas" },
      { id:"ovos",      label:"Ovos (36 unidades)",                  category:"Prote√≠nas" },
      { id:"carne",     label:"Carne vermelha magra (1‚Äì2kg)",        category:"Prote√≠nas" },
      { id:"peixe",     label:"Peixe (1kg)",                         category:"Prote√≠nas" },
      { id:"iogurte",   label:"Iogurte natural/greco s/ a√ß√∫car",     category:"Prote√≠nas" },
      { id:"cottage",   label:"Cottage / ricota (500g)",             category:"Prote√≠nas" },
      { id:"arrozint",  label:"Arroz integral (2kg)",                category:"Carboidratos" },
      { id:"batata",    label:"Batata doce (2,5kg)",                 category:"Carboidratos" },
      { id:"aveia",     label:"Aveia em flocos (1kg)",               category:"Carboidratos" },
      { id:"pao",       label:"P√£o integral 100% (2 pacotes)",       category:"Carboidratos" },
      { id:"banana",    label:"Banana (14 unid.)",                   category:"Carboidratos" },
      { id:"maca",      label:"Ma√ß√£ (7 unid.)",                      category:"Carboidratos" },
      { id:"folhas",    label:"Folhas verdes (3 pacotes)",           category:"Verduras/Legumes" },
      { id:"brocolis",  label:"Br√≥colis (2 cabe√ßas)",                category:"Verduras/Legumes" },
      { id:"abobrinha", label:"Abobrinha (4 unid.)",                 category:"Verduras/Legumes" },
      { id:"cenoura",   label:"Cenoura (1kg)",                       category:"Verduras/Legumes" },
      { id:"tomate",    label:"Tomate (1,5kg)",                      category:"Verduras/Legumes" },
      { id:"azeite",    label:"Azeite extra virgem (500ml)",         category:"Gorduras boas" },
      { id:"castanhas", label:"Castanhas/nozes (600g)",              category:"Gorduras boas" },
      { id:"abacate",   label:"Abacate (4 unid.)",                   category:"Gorduras boas" },
      { id:"pastaam",   label:"Pasta de amendoim (450g)",            category:"Gorduras boas" },
      { id:"agua",      label:"√Ågua (gal√µes/garrafas p/ semana)",    category:"Suporte" },
      { id:"cafe",      label:"Caf√© / ch√°s sem a√ß√∫car",              category:"Suporte" }
    ];

    function loadShopping() {
      const cont = document.getElementById("shoppingContainer");
      if (!cont) return;
      let state = {};
      try {
        const raw = localStorage.getItem(SHOPPING_KEY);
        state = raw ? JSON.parse(raw) : {};
      } catch { state = {}; }
      cont.innerHTML = "";
      const byCat = {};
      shoppingItems.forEach(item => {
        if (!byCat[item.category]) byCat[item.category] = [];
        byCat[item.category].push(item);
      });
      Object.keys(byCat).forEach(cat => {
        const catDiv = document.createElement("div");
        const title = document.createElement("div");
        title.className = "shopping-category-title";
        title.textContent = cat;
        catDiv.appendChild(title);
        byCat[cat].forEach(item => {
          const row = document.createElement("div");
          row.className = "shopping-item";
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.checked = !!state[item.id];
          chk.addEventListener("change", e => {
            state[item.id] = e.target.checked;
            localStorage.setItem(SHOPPING_KEY, JSON.stringify(state));
          });
          const span = document.createElement("span");
          span.textContent = item.label;
          row.appendChild(chk);
          row.appendChild(span);
          catDiv.appendChild(row);
        });
        cont.appendChild(catDiv);
      });
    }

    function renderCardapioDia() {
      const info = document.getElementById("alimDiaInfo");
      const cont = document.getElementById("alimDiaContainer");
      if (!info || !cont) return;
      const diaSel = getDiaSelecionado() || "dia padr√£o";
      const dataSel = getDataSelecionada();
      info.textContent =
        "Sugest√£o simples para " + diaSel + " (" + dataSel + "). Depois refinamos macros e quantidades.";

      let tipoDia = "musculacao";
      if (diaSel === "S√°bado" || diaSel === "Domingo") tipoDia = "corrida";
      if (diaSel === "Quinta") tipoDia = "leve";

      const blocos = [];
      if (tipoDia === "musculacao") {
        blocos.push({titulo:"Caf√© da manh√£", texto:"Ovos mexidos + aveia com fruta (banana/ma√ß√£) + caf√© sem a√ß√∫car."});
        blocos.push({titulo:"Almo√ßo", texto:"Frango/carne magra + arroz integral ou batata doce + salada e legumes."});
        blocos.push({titulo:"Lanche pr√©-treino", texto:"P√£o integral + pasta de amendoim OU banana + caf√©. Energia para a muscula√ß√£o."});
        blocos.push({titulo:"Jantar", texto:"Peixe ou frango + legumes + salada. Carbo moderado, prote√≠na alta."});
        blocos.push({titulo:"Ceia", texto:"Iogurte + castanhas ou cottage. Prote√≠na + gordura boa."});
      } else if (tipoDia === "corrida") {
        blocos.push({titulo:"Pr√©-corrida", texto:"Banana + mel OU p√£o integral com geleia, 30‚Äì60min antes de correr."});
        blocos.push({titulo:"P√≥s-corrida", texto:"Iogurte + fruta + aveia. Repor carboidrato e prote√≠na leve, muita √°gua."});
        blocos.push({titulo:"Refei√ß√µes principais", texto:"Frango/peixe + arroz integral/batata + legumes. Muito l√≠quido ao longo do dia."});
      } else {
        blocos.push({titulo:"Dia leve", texto:"Manter prote√≠na alta, carbo moderado e muitas fibras (saladas e legumes)."});
      }

      cont.innerHTML = "";
      blocos.forEach(b => {
        const div = document.createElement("div");
        div.className = "meal-block";
        const t = document.createElement("div");
        t.className = "meal-title";
        t.textContent = b.titulo;
        const p = document.createElement("div");
        p.textContent = b.texto;
        div.appendChild(t);
        div.appendChild(p);
        cont.appendChild(div);
      });
    }

    function renderCardapioSemana() {
      const cont = document.getElementById("alimSemanaContainer");
      if (!cont) return;
      cont.innerHTML = `
        <div class="help-text" style="margin-bottom:6px;">
          Estrutura alvo (~2.200‚Äì2.400 kcal/dia, 160‚Äì180g prote√≠na):
        </div>
        <ul style="padding-left:18px; font-size:13px;">
          <li>Prote√≠na em todas as refei√ß√µes principais (frango, carne magra, peixe, ovos, iogurte).</li>
          <li>Carboidratos focados perto de treino/corrida (arroz, batata doce, p√£o integral, aveia).</li>
          <li>Verduras e legumes em pelo menos 2 refei√ß√µes ao dia.</li>
          <li>Gorduras boas moderadas (azeite, castanhas, abacate, pasta de amendoim).</li>
          <li>Hidrata√ß√£o alta, com aten√ß√£o extra nos dias de corrida.</li>
        </ul>`;
    }

    /* ---- TABS / INIT ---- */
    function initMainTabs() {
      const buttons = document.querySelectorAll(".top-tab-btn");
      const viewTreino = document.getElementById("view-treino");
      const viewAlim = document.getElementById("view-alimentacao");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          if (btn.dataset.main === "treino") {
            viewTreino.classList.remove("hidden");
            viewAlim.classList.add("hidden");
          } else {
            viewTreino.classList.add("hidden");
            viewAlim.classList.remove("hidden");
          }
        });
      });
    }

    function initTreinoTabs() {
      const btns = document.querySelectorAll("[data-tab-treino]");
      const tabDia = document.getElementById("tab-dia");
      const tabCardio = document.getElementById("tab-cardio");
      btns.forEach(btn => {
        btn.addEventListener("click", () => {
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tabTreino;
          if (tab === "dia") {
            tabDia.classList.remove("hidden");
            tabCardio.classList.add("hidden");
          } else {
            tabDia.classList.add("hidden");
            tabCardio.classList.remove("hidden");
          }
        });
      });
    }

    function initAlimTabs() {
      const btns = document.querySelectorAll("[data-tab-alim]");
      const d = document.getElementById("alim-dia");
      const s = document.getElementById("alim-semana");
      const c = document.getElementById("alim-compras");
      btns.forEach(btn => {
        btn.addEventListener("click", () => {
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tabAlim;
          d.classList.add("hidden");
          s.classList.add("hidden");
          c.classList.add("hidden");
          if (tab === "dia") d.classList.remove("hidden");
          if (tab === "semana") s.classList.remove("hidden");
          if (tab === "compras") c.classList.remove("hidden");
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadDailyLog();

      const dataInput = document.getElementById("dataInput");
      if (dataInput && !dataInput.value) dataInput.value = todayISO();

      initMainTabs();
      initTreinoTabs();
      initAlimTabs();

      loadShopping();
      renderCardapioSemana();
      renderCardapioDia();

      const csvInput = document.getElementById("csvInput");
      if (csvInput) {
        csvInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              baseExercises = parseCSV(ev.target.result);
              setStatus("Arquivo carregado com " + baseExercises.length + " linhas.");
              rebuildDiaOptions();
              renderDia();
              renderCardapioDia();
            } catch (err) {
              console.error(err);
              setStatus("Erro ao ler arquivo de treinos.");
            }
          };
          reader.readAsText(file, "utf-8");
        });
      }

      const diaSelect = document.getElementById("diaSelect");
      if (diaSelect) {
        diaSelect.addEventListener("change", () => {
          renderDia();
          renderCardapioDia();
        });
      }

      if (dataInput) {
        dataInput.addEventListener("change", () => {
          renderDia();
          renderCardapioDia();
        });
      }

      const btnExport = document.getElementById("btnExport");
      if (btnExport) btnExport.addEventListener("click", exportJson);
      const btnReset = document.getElementById("btnReset");
      if (btnReset) btnReset.addEventListener("click", resetDia);
    });
  </script>
</body>
</html>
